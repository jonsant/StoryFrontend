import{H as S,L as N,M as T,T as b,Ya as p,_a as q,b as v,g as m,i as E,k as l,l as A,m as w,mb as P,n as R,nb as h,ob as _,r as U,s as C,w as y}from"./chunk-ISGQR6HD.js";import{a as I,b as k,f as u}from"./chunk-FO65GQC2.js";function x(d){return d.status!==void 0}var a={UserInteractionRequired:"USER_INTERACTION_REQUIRED",UserCancel:"USER_CANCEL",NoNetwork:"NO_NETWORK",TransientError:"TRANSIENT_ERROR",PersistentError:"PERSISTENT_ERROR",Disabled:"DISABLED",AccountUnavailable:"ACCOUNT_UNAVAILABLE",NestedAppAuthUnavailable:"NESTED_APP_AUTH_UNAVAILABLE"};var g=class{constructor(e,t,n,r){this.clientId=e,this.clientCapabilities=t,this.crypto=n,this.logger=r}toNaaTokenRequest(e){let t;e.extraQueryParameters===void 0?t=new Map:t=new Map(Object.entries(e.extraQueryParameters));let r=new N().addClientCapabilitiesToClaims(e.claims,this.clientCapabilities),i=e.scopes||v;return{platformBrokerId:e.account?.homeAccountId,clientId:this.clientId,authority:e.authority,scope:i.join(" "),correlationId:e.correlationId!==void 0?e.correlationId:this.crypto.createNewGuid(),claims:y.isEmptyObj(r)?void 0:r,state:e.state,authenticationScheme:e.authenticationScheme||m.BEARER,extraParameters:t}}fromNaaTokenResponse(e,t,n){if(!t.token.id_token||!t.token.access_token)throw w(l.nullOrEmptyToken);let r=new Date((n+(t.token.expires_in||0))*1e3),i=U.extractTokenClaims(t.token.id_token,this.crypto.base64Decode),c=this.fromNaaAccountInfo(t.account,i),s=t.token.scope||e.scope;return{authority:t.token.authority||c.environment,uniqueId:c.localAccountId,tenantId:c.tenantId,scopes:s.split(" "),account:c,idToken:t.token.id_token,idTokenClaims:i,accessToken:t.token.access_token,fromCache:!0,expiresOn:r,tokenType:e.authenticationScheme||m.BEARER,correlationId:e.correlationId,extExpiresOn:r,state:e.state}}fromNaaAccountInfo(e,t){let n=t||e.idTokenClaims,r=e.localAccountId||n?.oid||n?.sub||"",i=e.tenantId||n?.tid||"",c=e.homeAccountId||`${r}.${i}`,s=e.username||n?.preferred_username||"",f=e.name||n?.name;return{homeAccountId:c,environment:e.environment,tenantId:i,username:s,localAccountId:r,name:f,idToken:e.idToken,idTokenClaims:n}}fromBridgeError(e){if(x(e))switch(e.status){case a.UserCancel:return new A(l.userCanceled);case a.NoNetwork:return new A(l.noNetworkConnectivity);case a.AccountUnavailable:return new A(l.noAccountFound);case a.Disabled:return new A(l.nestedAppAuthBridgeDisabled);case a.NestedAppAuthUnavailable:return new A(e.code||l.nestedAppAuthBridgeDisabled,e.description);case a.TransientError:case a.PersistentError:return new S(e.code,e.description);case a.UserInteractionRequired:return new b(e.code,e.description);default:return new E(e.code,e.description)}else return new E("unknown_error","An unknown error occurred")}};var B={unsupportedMethod:{code:"unsupported_method",desc:"The PKCE code challenge and verifier could not be generated."}},o=class d extends E{constructor(e,t){super(e,t),Object.setPrototypeOf(this,d.prototype),this.name="NestedAppAuthError"}static createUnsupportedError(){return new d(B.unsupportedMethod.code,B.unsupportedMethod.desc)}};var O=class d{constructor(e){this.operatingContext=e;let t=this.operatingContext.getBridgeProxy();if(t!==void 0)this.bridgeProxy=t;else throw new Error("unexpected: bridgeProxy is undefined");this.config=e.getConfig(),this.logger=this.operatingContext.getLogger(),this.performanceClient=this.config.telemetry.client,this.browserCrypto=e.isBrowserEnvironment()?new P(this.logger,this.performanceClient):R,this.eventHandler=new _(this.logger,this.browserCrypto),this.nestedAppAuthAdapter=new g(this.config.auth.clientId,this.config.auth.clientCapabilities,this.browserCrypto,this.logger)}getBrowserStorage(){throw o.createUnsupportedError()}getEventHandler(){return this.eventHandler}static createController(e){return u(this,null,function*(){let t=new d(e);return Promise.resolve(t)})}initialize(){return Promise.resolve()}ensureValidRequest(e){return e?.correlationId?e:k(I({},e),{correlationId:this.browserCrypto.createNewGuid()})}acquireTokenInteractive(e){return u(this,null,function*(){let t=this.ensureValidRequest(e);this.eventHandler.emitEvent(h.ACQUIRE_TOKEN_START,p.Popup,t);let n=this.performanceClient.startMeasurement(T.AcquireTokenPopup,t.correlationId);n?.add({nestedAppAuthRequest:!0});try{let r=this.nestedAppAuthAdapter.toNaaTokenRequest(t),i=C.nowSeconds(),c=yield this.bridgeProxy.getTokenInteractive(r),s=this.nestedAppAuthAdapter.fromNaaTokenResponse(r,c,i);return this.operatingContext.setActiveAccount(s.account),this.eventHandler.emitEvent(h.ACQUIRE_TOKEN_SUCCESS,p.Popup,s),n.add({accessTokenSize:s.accessToken.length,idTokenSize:s.idToken.length}),n.end({success:!0,requestId:s.requestId}),s}catch(r){let i=this.nestedAppAuthAdapter.fromBridgeError(r);throw this.eventHandler.emitEvent(h.ACQUIRE_TOKEN_FAILURE,p.Popup,null,r),n.end({success:!1},r),i}})}acquireTokenSilentInternal(e){return u(this,null,function*(){let t=this.ensureValidRequest(e);this.eventHandler.emitEvent(h.ACQUIRE_TOKEN_START,p.Silent,t);let n=this.performanceClient.startMeasurement(T.SsoSilent,t.correlationId);n?.increment({visibilityChangeCount:0}),n?.add({nestedAppAuthRequest:!0});try{let r=this.nestedAppAuthAdapter.toNaaTokenRequest(t),i=C.nowSeconds(),c=yield this.bridgeProxy.getTokenSilent(r),s=this.nestedAppAuthAdapter.fromNaaTokenResponse(r,c,i);return this.operatingContext.setActiveAccount(s.account),this.eventHandler.emitEvent(h.ACQUIRE_TOKEN_SUCCESS,p.Silent,s),n?.add({accessTokenSize:s.accessToken.length,idTokenSize:s.idToken.length}),n?.end({success:!0,requestId:s.requestId}),s}catch(r){let i=this.nestedAppAuthAdapter.fromBridgeError(r);throw this.eventHandler.emitEvent(h.ACQUIRE_TOKEN_FAILURE,p.Silent,null,r),n?.end({success:!1},r),i}})}acquireTokenPopup(e){return u(this,null,function*(){return this.acquireTokenInteractive(e)})}acquireTokenRedirect(e){throw o.createUnsupportedError()}acquireTokenSilent(e){return u(this,null,function*(){return this.acquireTokenSilentInternal(e)})}acquireTokenByCode(e){throw o.createUnsupportedError()}acquireTokenNative(e,t,n){throw o.createUnsupportedError()}acquireTokenByRefreshToken(e,t){throw o.createUnsupportedError()}addEventCallback(e){return this.eventHandler.addEventCallback(e)}removeEventCallback(e){this.eventHandler.removeEventCallback(e)}addPerformanceCallback(e){throw o.createUnsupportedError()}removePerformanceCallback(e){throw o.createUnsupportedError()}enableAccountStorageEvents(){throw o.createUnsupportedError()}disableAccountStorageEvents(){throw o.createUnsupportedError()}getAccount(e){throw o.createUnsupportedError()}getAccountByHomeId(e){let t=this.operatingContext.getActiveAccount();return t!==void 0&&t.homeAccountId===e?this.nestedAppAuthAdapter.fromNaaAccountInfo(t):null}getAccountByLocalId(e){let t=this.operatingContext.getActiveAccount();return t!==void 0&&t.localAccountId===e?this.nestedAppAuthAdapter.fromNaaAccountInfo(t):null}getAccountByUsername(e){let t=this.operatingContext.getActiveAccount();return t!==void 0&&t.username===e?this.nestedAppAuthAdapter.fromNaaAccountInfo(t):null}getAllAccounts(){let e=this.operatingContext.getActiveAccount();return e!==void 0?[this.nestedAppAuthAdapter.fromNaaAccountInfo(e)]:[]}handleRedirectPromise(e){return Promise.resolve(null)}loginPopup(e){return this.acquireTokenInteractive(e||q)}loginRedirect(e){throw o.createUnsupportedError()}logout(e){throw o.createUnsupportedError()}logoutRedirect(e){throw o.createUnsupportedError()}logoutPopup(e){throw o.createUnsupportedError()}ssoSilent(e){return this.acquireTokenSilentInternal(e)}getTokenCache(){throw o.createUnsupportedError()}getLogger(){return this.logger}setLogger(e){this.logger=e}setActiveAccount(e){this.logger.warning("nestedAppAuth does not support setActiveAccount")}getActiveAccount(){let e=this.operatingContext.getActiveAccount();return e!==void 0?this.nestedAppAuthAdapter.fromNaaAccountInfo(e):null}initializeWrapperLibrary(e,t){}setNavigationClient(e){this.logger.warning("setNavigationClient is not supported in nested app auth")}getConfiguration(){return this.config}isBrowserEnv(){return this.operatingContext.isBrowserEnvironment()}getBrowserCrypto(){return this.browserCrypto}getPerformanceClient(){throw o.createUnsupportedError()}getRedirectResponse(){throw o.createUnsupportedError()}clearCache(e){return u(this,null,function*(){throw o.createUnsupportedError()})}hydrateCache(e,t){return u(this,null,function*(){throw o.createUnsupportedError()})}};export{O as NestedAppAuthController};
