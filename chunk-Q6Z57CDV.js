import{$ as Lt,A as re,Aa as ir,B as H,Ba as pt,C as le,Ca as G,D as b,Da as or,E as Mt,Ea as nr,F as dt,Fa as ar,G as _t,Ga as sr,H as Le,Ha as cr,I as Ke,Ia as hr,J as de,Ja as lr,K as ut,Ka as oe,La as dr,M as h,Ma as ur,N as q,Na as gr,O as g,Oa as u,P as Ae,Pa as N,Q as Ot,Qa as ce,R as Ht,Ra as J,S as ue,Sa as R,T as ge,Ta as ft,U as Bt,Ua as T,V as ie,Va as j,W as B,Wa as Ee,X as gt,Xa as w,Y as xe,Ya as p,Z as De,_ as Ut,_a as Ct,a as m,aa as Kt,ab as V,b as Oe,ba as xt,bb as mr,c as k,ca as Dt,d as P,da as mt,e as Z,ea as me,eb as vt,f as S,fa as Ft,fb as pr,g as x,ga as Fe,gb as fr,h as He,ha as qt,hb as Cr,i as M,ia as zt,ib as U,j as Be,ja as $t,jb as vr,k as _,ka as Gt,kb as z,la as Vt,lb as It,m as O,ma as Wt,mb as Ir,n as Ue,na as Q,nb as v,o as Rt,oa as Yt,ob as yr,p as kt,pa as Qt,q as bt,qa as Jt,r as he,ra as jt,s as lt,sa as pe,t as E,ta as Xt,u as ee,ua as Zt,v as te,va as er,w as we,wa as qe,x as Y,xa as tr,y as Nt,ya as Se,z as Pt,za as rr}from"./chunk-ISGQR6HD.js";import{a as f,b as y,c as ht,d as zr,e as _e,f as d}from"./chunk-FO65GQC2.js";var fe="storage_not_supported",ze="stubbed_public_client_application_called",Ce="in_mem_redirect_unavailable";var $e={[fe]:"Given storage configuration option was not supported.",[ze]:"Stub instance of Public Client Application was called. If using msal-react, please ensure context is not used without a provider. For more visit: aka.ms/msaljs/browser-errors",[Ce]:"Redirect cannot be supported. In-memory storage was selected and storeAuthStateInCookie=false, which would cause the library to be unable to handle the incoming hash. If you would like to use the redirect API, please use session/localStorage or set storeAuthStateInCookie=true."},ci={storageNotSupportedError:{code:fe,desc:$e[fe]},stubPcaInstanceCalled:{code:ze,desc:$e[ze]},inMemRedirectUnavailable:{code:Ce,desc:$e[Ce]}},yt=class a extends M{constructor(e,t){super(e,t),this.name="BrowserConfigurationAuthError",Object.setPrototypeOf(this,a.prototype)}};function Ge(a){return new yt(a,$e[a])}var Re=class{constructor(e){this.validateWindowStorage(e),this.windowStorage=window[e]}validateWindowStorage(e){if(e!==R.LocalStorage&&e!==R.SessionStorage||!window[e])throw Ge(fe)}getItem(e){return this.windowStorage.getItem(e)}setItem(e,t){this.windowStorage.setItem(e,t)}removeItem(e){this.windowStorage.removeItem(e)}getKeys(){return Object.keys(this.windowStorage)}containsKey(e){return this.windowStorage.hasOwnProperty(e)}};function Ve(a,e){if(!e)return null;try{return B.parseRequestState(a,e).libraryState.meta}catch{throw O(_.invalidState)}}var ve=class a extends dt{constructor(e,t,r,i,o,n){super(e,r,i,o),this.COOKIE_LIFE_MULTIPLIER=24*60*60*1e3,this.cacheConfig=t,this.logger=i,this.internalStorage=new It,this.browserStorage=this.setupBrowserStorage(this.cacheConfig.cacheLocation),this.temporaryCacheStorage=this.setupTemporaryCacheStorage(this.cacheConfig.temporaryCacheLocation,this.cacheConfig.cacheLocation),t.cacheMigrationEnabled&&(this.migrateCacheEntries(),this.createKeyMaps()),this.performanceClient=n}setupBrowserStorage(e){switch(e){case R.LocalStorage:case R.SessionStorage:try{return new Re(e)}catch(t){this.logger.verbose(t);break}}return this.cacheConfig.cacheLocation=R.MemoryStorage,new It}setupTemporaryCacheStorage(e,t){switch(t){case R.LocalStorage:case R.SessionStorage:try{return new Re(e||R.SessionStorage)}catch(r){return this.logger.verbose(r),this.internalStorage}case R.MemoryStorage:default:return this.internalStorage}}migrateCacheEntries(){let e=`${m.CACHE_PREFIX}.${k.ID_TOKEN}`,t=`${m.CACHE_PREFIX}.${k.CLIENT_INFO}`,r=`${m.CACHE_PREFIX}.${k.ERROR}`,i=`${m.CACHE_PREFIX}.${k.ERROR_DESC}`,o=this.browserStorage.getItem(e),n=this.browserStorage.getItem(t),c=this.browserStorage.getItem(r),s=this.browserStorage.getItem(i),l=[o,n,c,s];[k.ID_TOKEN,k.CLIENT_INFO,k.ERROR,k.ERROR_DESC].forEach((I,A)=>{let F=l[A];F&&this.setTemporaryCache(I,F,!0)})}createKeyMaps(){this.logger.trace("BrowserCacheManager - createKeyMaps called.");let e=this.getItem(j.ACCOUNT_KEYS),t=this.getItem(`${j.TOKEN_KEYS}.${this.clientId}`);if(e&&t){this.logger.verbose("BrowserCacheManager:createKeyMaps - account and token key maps already exist, skipping migration.");return}this.browserStorage.getKeys().forEach(i=>{if(this.isCredentialKey(i)){let o=this.getItem(i);if(o){let n=this.validateAndParseJson(o);if(n&&n.hasOwnProperty("credentialType"))switch(n.credentialType){case S.ID_TOKEN:if(E.isIdTokenEntity(n)){this.logger.trace("BrowserCacheManager:createKeyMaps - idToken found, saving key to token key map"),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - idToken with key: ${i} found, saving key to token key map`);let c=n,s=this.updateCredentialCacheKey(i,c);this.addTokenKey(s,S.ID_TOKEN);return}else this.logger.trace("BrowserCacheManager:createKeyMaps - key found matching idToken schema with value containing idToken credentialType field but value failed IdTokenEntity validation, skipping."),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - failed idToken validation on key: ${i}`);break;case S.ACCESS_TOKEN:case S.ACCESS_TOKEN_WITH_AUTH_SCHEME:if(E.isAccessTokenEntity(n)){this.logger.trace("BrowserCacheManager:createKeyMaps - accessToken found, saving key to token key map"),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - accessToken with key: ${i} found, saving key to token key map`);let c=n,s=this.updateCredentialCacheKey(i,c);this.addTokenKey(s,S.ACCESS_TOKEN);return}else this.logger.trace("BrowserCacheManager:createKeyMaps - key found matching accessToken schema with value containing accessToken credentialType field but value failed AccessTokenEntity validation, skipping."),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - failed accessToken validation on key: ${i}`);break;case S.REFRESH_TOKEN:if(E.isRefreshTokenEntity(n)){this.logger.trace("BrowserCacheManager:createKeyMaps - refreshToken found, saving key to token key map"),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - refreshToken with key: ${i} found, saving key to token key map`);let c=n,s=this.updateCredentialCacheKey(i,c);this.addTokenKey(s,S.REFRESH_TOKEN);return}else this.logger.trace("BrowserCacheManager:createKeyMaps - key found matching refreshToken schema with value containing refreshToken credentialType field but value failed RefreshTokenEntity validation, skipping."),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - failed refreshToken validation on key: ${i}`);break}}}if(this.isAccountKey(i)){let o=this.getItem(i);if(o){let n=this.validateAndParseJson(o);n&&H.isAccountEntity(n)&&(this.logger.trace("BrowserCacheManager:createKeyMaps - account found, saving key to account key map"),this.logger.tracePii(`BrowserCacheManager:createKeyMaps - account with key: ${i} found, saving key to account key map`),this.addAccountKeyToMap(i))}}})}validateAndParseJson(e){try{let t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch{return null}}getItem(e){return this.browserStorage.getItem(e)}setItem(e,t){this.browserStorage.setItem(e,t)}getAccount(e,t){this.logger.trace("BrowserCacheManager.getAccount called");let r=this.getCachedAccountEntity(e);return this.updateOutdatedCachedAccount(e,r,t)}getCachedAccountEntity(e){let t=this.getItem(e);if(!t)return this.removeAccountKeyFromMap(e),null;let r=this.validateAndParseJson(t);return!r||!H.isAccountEntity(r)?(this.removeAccountKeyFromMap(e),null):dt.toObject(new H,r)}setAccount(e){this.logger.trace("BrowserCacheManager.setAccount called");let t=e.generateAccountKey();this.setItem(t,JSON.stringify(e)),this.addAccountKeyToMap(t)}getAccountKeys(){this.logger.trace("BrowserCacheManager.getAccountKeys called");let e=this.getItem(j.ACCOUNT_KEYS);return e?JSON.parse(e):(this.logger.verbose("BrowserCacheManager.getAccountKeys - No account keys found"),[])}addAccountKeyToMap(e){this.logger.trace("BrowserCacheManager.addAccountKeyToMap called"),this.logger.tracePii(`BrowserCacheManager.addAccountKeyToMap called with key: ${e}`);let t=this.getAccountKeys();t.indexOf(e)===-1?(t.push(e),this.setItem(j.ACCOUNT_KEYS,JSON.stringify(t)),this.logger.verbose("BrowserCacheManager.addAccountKeyToMap account key added")):this.logger.verbose("BrowserCacheManager.addAccountKeyToMap account key already exists in map")}removeAccountKeyFromMap(e){this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap called"),this.logger.tracePii(`BrowserCacheManager.removeAccountKeyFromMap called with key: ${e}`);let t=this.getAccountKeys(),r=t.indexOf(e);r>-1?(t.splice(r,1),this.setItem(j.ACCOUNT_KEYS,JSON.stringify(t)),this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap account key removed")):this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap key not found in existing map")}removeAccount(e){return d(this,null,function*(){_e(a.prototype,this,"removeAccount").call(this,e),this.removeAccountKeyFromMap(e)})}removeOutdatedAccount(e){this.removeItem(e),this.removeAccountKeyFromMap(e)}removeIdToken(e){super.removeIdToken(e),this.removeTokenKey(e,S.ID_TOKEN)}removeAccessToken(e){return d(this,null,function*(){_e(a.prototype,this,"removeAccessToken").call(this,e),this.removeTokenKey(e,S.ACCESS_TOKEN)})}removeRefreshToken(e){super.removeRefreshToken(e),this.removeTokenKey(e,S.REFRESH_TOKEN)}getTokenKeys(){this.logger.trace("BrowserCacheManager.getTokenKeys called");let e=this.getItem(`${j.TOKEN_KEYS}.${this.clientId}`);if(e){let t=this.validateAndParseJson(e);if(t&&t.hasOwnProperty("idToken")&&t.hasOwnProperty("accessToken")&&t.hasOwnProperty("refreshToken"))return t;this.logger.error("BrowserCacheManager.getTokenKeys - Token keys found but in an unknown format. Returning empty key map.")}else this.logger.verbose("BrowserCacheManager.getTokenKeys - No token keys found");return{idToken:[],accessToken:[],refreshToken:[]}}addTokenKey(e,t){this.logger.trace("BrowserCacheManager addTokenKey called");let r=this.getTokenKeys();switch(t){case S.ID_TOKEN:r.idToken.indexOf(e)===-1&&(this.logger.info("BrowserCacheManager: addTokenKey - idToken added to map"),r.idToken.push(e));break;case S.ACCESS_TOKEN:r.accessToken.indexOf(e)===-1&&(this.logger.info("BrowserCacheManager: addTokenKey - accessToken added to map"),r.accessToken.push(e));break;case S.REFRESH_TOKEN:r.refreshToken.indexOf(e)===-1&&(this.logger.info("BrowserCacheManager: addTokenKey - refreshToken added to map"),r.refreshToken.push(e));break;default:throw this.logger.error(`BrowserCacheManager:addTokenKey - CredentialType provided invalid. CredentialType: ${t}`),O(_.unexpectedCredentialType)}this.setItem(`${j.TOKEN_KEYS}.${this.clientId}`,JSON.stringify(r))}removeTokenKey(e,t){this.logger.trace("BrowserCacheManager removeTokenKey called");let r=this.getTokenKeys();switch(t){case S.ID_TOKEN:this.logger.infoPii(`BrowserCacheManager: removeTokenKey - attempting to remove idToken with key: ${e} from map`);let i=r.idToken.indexOf(e);i>-1?(this.logger.info("BrowserCacheManager: removeTokenKey - idToken removed from map"),r.idToken.splice(i,1)):this.logger.info("BrowserCacheManager: removeTokenKey - idToken does not exist in map. Either it was previously removed or it was never added.");break;case S.ACCESS_TOKEN:this.logger.infoPii(`BrowserCacheManager: removeTokenKey - attempting to remove accessToken with key: ${e} from map`);let o=r.accessToken.indexOf(e);o>-1?(this.logger.info("BrowserCacheManager: removeTokenKey - accessToken removed from map"),r.accessToken.splice(o,1)):this.logger.info("BrowserCacheManager: removeTokenKey - accessToken does not exist in map. Either it was previously removed or it was never added.");break;case S.REFRESH_TOKEN:this.logger.infoPii(`BrowserCacheManager: removeTokenKey - attempting to remove refreshToken with key: ${e} from map`);let n=r.refreshToken.indexOf(e);n>-1?(this.logger.info("BrowserCacheManager: removeTokenKey - refreshToken removed from map"),r.refreshToken.splice(n,1)):this.logger.info("BrowserCacheManager: removeTokenKey - refreshToken does not exist in map. Either it was previously removed or it was never added.");break;default:throw this.logger.error(`BrowserCacheManager:removeTokenKey - CredentialType provided invalid. CredentialType: ${t}`),O(_.unexpectedCredentialType)}this.setItem(`${j.TOKEN_KEYS}.${this.clientId}`,JSON.stringify(r))}getIdTokenCredential(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getIdTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.ID_TOKEN),null;let r=this.validateAndParseJson(t);return!r||!E.isIdTokenEntity(r)?(this.logger.trace("BrowserCacheManager.getIdTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.ID_TOKEN),null):(this.logger.trace("BrowserCacheManager.getIdTokenCredential: cache hit"),r)}setIdTokenCredential(e){this.logger.trace("BrowserCacheManager.setIdTokenCredential called");let t=E.generateCredentialKey(e);this.setItem(t,JSON.stringify(e)),this.addTokenKey(t,S.ID_TOKEN)}getAccessTokenCredential(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getAccessTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.ACCESS_TOKEN),null;let r=this.validateAndParseJson(t);return!r||!E.isAccessTokenEntity(r)?(this.logger.trace("BrowserCacheManager.getAccessTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.ACCESS_TOKEN),null):(this.logger.trace("BrowserCacheManager.getAccessTokenCredential: cache hit"),r)}setAccessTokenCredential(e){this.logger.trace("BrowserCacheManager.setAccessTokenCredential called");let t=E.generateCredentialKey(e);this.setItem(t,JSON.stringify(e)),this.addTokenKey(t,S.ACCESS_TOKEN)}getRefreshTokenCredential(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.REFRESH_TOKEN),null;let r=this.validateAndParseJson(t);return!r||!E.isRefreshTokenEntity(r)?(this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: called, no cache hit"),this.removeTokenKey(e,S.REFRESH_TOKEN),null):(this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: cache hit"),r)}setRefreshTokenCredential(e){this.logger.trace("BrowserCacheManager.setRefreshTokenCredential called");let t=E.generateCredentialKey(e);this.setItem(t,JSON.stringify(e)),this.addTokenKey(t,S.REFRESH_TOKEN)}getAppMetadata(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getAppMetadata: called, no cache hit"),null;let r=this.validateAndParseJson(t);return!r||!E.isAppMetadataEntity(e,r)?(this.logger.trace("BrowserCacheManager.getAppMetadata: called, no cache hit"),null):(this.logger.trace("BrowserCacheManager.getAppMetadata: cache hit"),r)}setAppMetadata(e){this.logger.trace("BrowserCacheManager.setAppMetadata called");let t=E.generateAppMetadataKey(e);this.setItem(t,JSON.stringify(e))}getServerTelemetry(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getServerTelemetry: called, no cache hit"),null;let r=this.validateAndParseJson(t);return!r||!E.isServerTelemetryEntity(e,r)?(this.logger.trace("BrowserCacheManager.getServerTelemetry: called, no cache hit"),null):(this.logger.trace("BrowserCacheManager.getServerTelemetry: cache hit"),r)}setServerTelemetry(e,t){this.logger.trace("BrowserCacheManager.setServerTelemetry called"),this.setItem(e,JSON.stringify(t))}getAuthorityMetadata(e){let t=this.internalStorage.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getAuthorityMetadata: called, no cache hit"),null;let r=this.validateAndParseJson(t);return r&&E.isAuthorityMetadataEntity(e,r)?(this.logger.trace("BrowserCacheManager.getAuthorityMetadata: cache hit"),r):null}getAuthorityMetadataKeys(){return this.internalStorage.getKeys().filter(t=>this.isAuthorityMetadata(t))}setWrapperMetadata(e,t){this.internalStorage.setItem(Ee.WRAPPER_SKU,e),this.internalStorage.setItem(Ee.WRAPPER_VER,t)}getWrapperMetadata(){let e=this.internalStorage.getItem(Ee.WRAPPER_SKU)||m.EMPTY_STRING,t=this.internalStorage.getItem(Ee.WRAPPER_VER)||m.EMPTY_STRING;return[e,t]}setAuthorityMetadata(e,t){this.logger.trace("BrowserCacheManager.setAuthorityMetadata called"),this.internalStorage.setItem(e,JSON.stringify(t))}getActiveAccount(){let e=this.generateCacheKey(k.ACTIVE_ACCOUNT_FILTERS),t=this.getItem(e);if(!t){this.logger.trace("BrowserCacheManager.getActiveAccount: No active account filters cache schema found, looking for legacy schema");let i=this.generateCacheKey(k.ACTIVE_ACCOUNT),o=this.getItem(i);if(!o)return this.logger.trace("BrowserCacheManager.getActiveAccount: No active account found"),null;let n=this.getAccountInfoFilteredBy({localAccountId:o});return n?(this.logger.trace("BrowserCacheManager.getActiveAccount: Legacy active account cache schema found"),this.logger.trace("BrowserCacheManager.getActiveAccount: Adding active account filters cache schema"),this.setActiveAccount(n),n):null}let r=this.validateAndParseJson(t);return r?(this.logger.trace("BrowserCacheManager.getActiveAccount: Active account filters schema found"),this.getAccountInfoFilteredBy({homeAccountId:r.homeAccountId,localAccountId:r.localAccountId,tenantId:r.tenantId})):(this.logger.trace("BrowserCacheManager.getActiveAccount: No active account found"),null)}setActiveAccount(e){let t=this.generateCacheKey(k.ACTIVE_ACCOUNT_FILTERS),r=this.generateCacheKey(k.ACTIVE_ACCOUNT);if(e){this.logger.verbose("setActiveAccount: Active account set");let i={homeAccountId:e.homeAccountId,localAccountId:e.localAccountId,tenantId:e.tenantId};this.browserStorage.setItem(t,JSON.stringify(i)),this.browserStorage.setItem(r,e.localAccountId)}else this.logger.verbose("setActiveAccount: No account passed, active account not set"),this.browserStorage.removeItem(t),this.browserStorage.removeItem(r)}getThrottlingCache(e){let t=this.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getThrottlingCache: called, no cache hit"),null;let r=this.validateAndParseJson(t);return!r||!E.isThrottlingEntity(e,r)?(this.logger.trace("BrowserCacheManager.getThrottlingCache: called, no cache hit"),null):(this.logger.trace("BrowserCacheManager.getThrottlingCache: cache hit"),r)}setThrottlingCache(e,t){this.logger.trace("BrowserCacheManager.setThrottlingCache called"),this.setItem(e,JSON.stringify(t))}getTemporaryCache(e,t){let r=t?this.generateCacheKey(e):e;if(this.cacheConfig.storeAuthStateInCookie){let o=this.getItemCookie(r);if(o)return this.logger.trace("BrowserCacheManager.getTemporaryCache: storeAuthStateInCookies set to true, retrieving from cookies"),o}let i=this.temporaryCacheStorage.getItem(r);if(!i){if(this.cacheConfig.cacheLocation===R.LocalStorage){let o=this.browserStorage.getItem(r);if(o)return this.logger.trace("BrowserCacheManager.getTemporaryCache: Temporary cache item found in local storage"),o}return this.logger.trace("BrowserCacheManager.getTemporaryCache: No cache item found in local storage"),null}return this.logger.trace("BrowserCacheManager.getTemporaryCache: Temporary cache item returned"),i}setTemporaryCache(e,t,r){let i=r?this.generateCacheKey(e):e;this.temporaryCacheStorage.setItem(i,t),this.cacheConfig.storeAuthStateInCookie&&(this.logger.trace("BrowserCacheManager.setTemporaryCache: storeAuthStateInCookie set to true, setting item cookie"),this.setItemCookie(i,t))}removeItem(e){this.browserStorage.removeItem(e)}removeTemporaryItem(e){this.temporaryCacheStorage.removeItem(e),this.cacheConfig.storeAuthStateInCookie&&(this.logger.trace("BrowserCacheManager.removeItem: storeAuthStateInCookie is true, clearing item cookie"),this.clearItemCookie(e))}getKeys(){return this.browserStorage.getKeys()}clear(){return d(this,null,function*(){yield this.removeAllAccounts(),this.removeAppMetadata(),this.temporaryCacheStorage.getKeys().forEach(e=>{(e.indexOf(m.CACHE_PREFIX)!==-1||e.indexOf(this.clientId)!==-1)&&this.removeTemporaryItem(e)}),this.browserStorage.getKeys().forEach(e=>{(e.indexOf(m.CACHE_PREFIX)!==-1||e.indexOf(this.clientId)!==-1)&&this.browserStorage.removeItem(e)}),this.internalStorage.clear()})}clearTokensAndKeysWithClaims(e){return d(this,null,function*(){e.addQueueMeasurement(h.ClearTokensAndKeysWithClaims);let t=this.getTokenKeys(),r=[];t.accessToken.forEach(i=>{let o=this.getAccessTokenCredential(i);o?.requestedClaimsHash&&i.includes(o.requestedClaimsHash.toLowerCase())&&r.push(this.removeAccessToken(i))}),yield Promise.all(r),r.length>0&&this.logger.warning(`${r.length} access tokens with claims in the cache keys have been removed from the cache.`)})}setItemCookie(e,t,r){let i=`${encodeURIComponent(e)}=${encodeURIComponent(t)};path=/;SameSite=Lax;`;if(r){let o=this.getCookieExpirationTime(r);i+=`expires=${o};`}this.cacheConfig.secureCookies&&(i+="Secure;"),document.cookie=i}getItemCookie(e){let t=`${encodeURIComponent(e)}=`,r=document.cookie.split(";");for(let i=0;i<r.length;i++){let o=r[i];for(;o.charAt(0)===" ";)o=o.substring(1);if(o.indexOf(t)===0)return decodeURIComponent(o.substring(t.length,o.length))}return m.EMPTY_STRING}clearMsalCookies(){let e=`${m.CACHE_PREFIX}.${this.clientId}`;document.cookie.split(";").forEach(r=>{for(;r.charAt(0)===" ";)r=r.substring(1);if(r.indexOf(e)===0){let i=r.split("=")[0];this.clearItemCookie(i)}})}clearItemCookie(e){this.setItemCookie(e,m.EMPTY_STRING,-1)}getCookieExpirationTime(e){let t=new Date;return new Date(t.getTime()+e*this.COOKIE_LIFE_MULTIPLIER).toUTCString()}generateCacheKey(e){return this.validateAndParseJson(e)?JSON.stringify(e):we.startsWith(e,m.CACHE_PREFIX)||we.startsWith(e,k.ADAL_ID_TOKEN)?e:`${m.CACHE_PREFIX}.${this.clientId}.${e}`}generateAuthorityKey(e){let{libraryState:{id:t}}=B.parseRequestState(this.cryptoImpl,e);return this.generateCacheKey(`${T.AUTHORITY}.${t}`)}generateNonceKey(e){let{libraryState:{id:t}}=B.parseRequestState(this.cryptoImpl,e);return this.generateCacheKey(`${T.NONCE_IDTOKEN}.${t}`)}generateStateKey(e){let{libraryState:{id:t}}=B.parseRequestState(this.cryptoImpl,e);return this.generateCacheKey(`${T.REQUEST_STATE}.${t}`)}getCachedAuthority(e){let t=this.generateStateKey(e),r=this.getTemporaryCache(t);if(!r)return null;let i=this.generateAuthorityKey(r);return this.getTemporaryCache(i)}updateCacheEntries(e,t,r,i,o){this.logger.trace("BrowserCacheManager.updateCacheEntries called");let n=this.generateStateKey(e);this.setTemporaryCache(n,e,!1);let c=this.generateNonceKey(e);this.setTemporaryCache(c,t,!1);let s=this.generateAuthorityKey(e);if(this.setTemporaryCache(s,r,!1),o){let l={credential:o.homeAccountId,type:de.HOME_ACCOUNT_ID};this.setTemporaryCache(T.CCS_CREDENTIAL,JSON.stringify(l),!0)}else if(i){let l={credential:i,type:de.UPN};this.setTemporaryCache(T.CCS_CREDENTIAL,JSON.stringify(l),!0)}}resetRequestCache(e){this.logger.trace("BrowserCacheManager.resetRequestCache called"),e&&(this.temporaryCacheStorage.getKeys().forEach(t=>{t.indexOf(e)!==-1&&this.removeTemporaryItem(t)}),this.removeTemporaryItem(this.generateStateKey(e)),this.removeTemporaryItem(this.generateNonceKey(e)),this.removeTemporaryItem(this.generateAuthorityKey(e))),this.removeTemporaryItem(this.generateCacheKey(T.REQUEST_PARAMS)),this.removeTemporaryItem(this.generateCacheKey(T.ORIGIN_URI)),this.removeTemporaryItem(this.generateCacheKey(T.URL_HASH)),this.removeTemporaryItem(this.generateCacheKey(T.CORRELATION_ID)),this.removeTemporaryItem(this.generateCacheKey(T.CCS_CREDENTIAL)),this.removeTemporaryItem(this.generateCacheKey(T.NATIVE_REQUEST)),this.setInteractionInProgress(!1)}cleanRequestByState(e){if(this.logger.trace("BrowserCacheManager.cleanRequestByState called"),e){let t=this.generateStateKey(e),r=this.temporaryCacheStorage.getItem(t);this.logger.infoPii(`BrowserCacheManager.cleanRequestByState: Removing temporary cache items for state: ${r}`),this.resetRequestCache(r||m.EMPTY_STRING)}this.clearMsalCookies()}cleanRequestByInteractionType(e){this.logger.trace("BrowserCacheManager.cleanRequestByInteractionType called"),this.temporaryCacheStorage.getKeys().forEach(t=>{if(t.indexOf(T.REQUEST_STATE)===-1)return;let r=this.temporaryCacheStorage.getItem(t);if(!r)return;let i=Ve(this.cryptoImpl,r);i&&i.interactionType===e&&(this.logger.infoPii(`BrowserCacheManager.cleanRequestByInteractionType: Removing temporary cache items for state: ${r}`),this.resetRequestCache(r))}),this.clearMsalCookies(),this.setInteractionInProgress(!1)}cacheCodeRequest(e){this.logger.trace("BrowserCacheManager.cacheCodeRequest called");let t=pr(JSON.stringify(e));this.setTemporaryCache(T.REQUEST_PARAMS,t,!0)}getCachedRequest(e){this.logger.trace("BrowserCacheManager.getCachedRequest called");let t=this.getTemporaryCache(T.REQUEST_PARAMS,!0);if(!t)throw u(Zt);let r;try{r=JSON.parse(z(t))}catch(i){throw this.logger.errorPii(`Attempted to parse: ${t}`),this.logger.error(`Parsing cached token request threw with error: ${i}`),u(er)}if(this.removeTemporaryItem(this.generateCacheKey(T.REQUEST_PARAMS)),!r.authority){let i=this.generateAuthorityKey(e),o=this.getTemporaryCache(i);if(!o)throw u(qe);r.authority=o}return r}getCachedNativeRequest(){this.logger.trace("BrowserCacheManager.getCachedNativeRequest called");let e=this.getTemporaryCache(T.NATIVE_REQUEST,!0);if(!e)return this.logger.trace("BrowserCacheManager.getCachedNativeRequest: No cached native request found"),null;let t=this.validateAndParseJson(e);return t||(this.logger.error("BrowserCacheManager.getCachedNativeRequest: Unable to parse native request"),null)}isInteractionInProgress(e){let t=this.getInteractionInProgress();return e?t===this.clientId:!!t}getInteractionInProgress(){let e=`${m.CACHE_PREFIX}.${T.INTERACTION_STATUS_KEY}`;return this.getTemporaryCache(e,!1)}setInteractionInProgress(e){let t=`${m.CACHE_PREFIX}.${T.INTERACTION_STATUS_KEY}`;if(e){if(this.getInteractionInProgress())throw u(Gt);this.setTemporaryCache(t,this.clientId,!1)}else!e&&this.getInteractionInProgress()===this.clientId&&this.removeTemporaryItem(t)}getLegacyLoginHint(){let e=this.getTemporaryCache(k.ADAL_ID_TOKEN);e&&(this.browserStorage.removeItem(k.ADAL_ID_TOKEN),this.logger.verbose("Cached ADAL id token retrieved."));let t=this.getTemporaryCache(k.ID_TOKEN,!0);t&&(this.browserStorage.removeItem(this.generateCacheKey(k.ID_TOKEN)),this.logger.verbose("Cached MSAL.js v1 id token retrieved"));let r=t||e;if(r){let i=he.extractTokenClaims(r,z);if(i.preferred_username)return this.logger.verbose("No SSO params used and ADAL/MSAL v1 token retrieved, setting ADAL/MSAL v1 preferred_username as loginHint"),i.preferred_username;if(i.upn)return this.logger.verbose("No SSO params used and ADAL/MSAL v1 token retrieved, setting ADAL/MSAL v1 upn as loginHint"),i.upn;this.logger.verbose("No SSO params used and ADAL/MSAL v1 token retrieved, however, no account hint claim found. Enable preferred_username or upn id token claim to get SSO.")}return null}updateCredentialCacheKey(e,t){let r=E.generateCredentialKey(t);if(e!==r){let i=this.getItem(e);if(i)return this.browserStorage.removeItem(e),this.setItem(r,i),this.logger.verbose(`Updated an outdated ${t.credentialType} cache key`),r;this.logger.error(`Attempted to update an outdated ${t.credentialType} cache key but no item matching the outdated key was found in storage`)}return e}hydrateCache(e,t){return d(this,null,function*(){let r=E.createIdTokenEntity(e.account?.homeAccountId,e.account?.environment,e.idToken,this.clientId,e.tenantId),i;t.claims&&(i=yield this.cryptoImpl.hashString(t.claims));let o=E.createAccessTokenEntity(e.account?.homeAccountId,e.account.environment,e.accessToken,this.clientId,e.tenantId,e.scopes.join(" "),e.expiresOn?.getTime()||0,e.extExpiresOn?.getTime()||0,z,void 0,e.tokenType,void 0,t.sshKid,t.claims,i),n=new ie(void 0,r,o);return this.saveCacheRecord(n)})}saveCacheRecord(e,t,r){return d(this,null,function*(){try{yield _e(a.prototype,this,"saveCacheRecord").call(this,e,t,r)}catch(i){if(i instanceof Mt&&this.performanceClient&&r)try{let o=this.getTokenKeys();this.performanceClient.addFields({cacheRtCount:o.refreshToken.length,cacheIdCount:o.idToken.length,cacheAtCount:o.accessToken.length},r)}catch{}throw i}})}},Tr=(a,e)=>{let t={cacheLocation:R.MemoryStorage,temporaryCacheLocation:R.MemoryStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!1,claimsBasedCachingEnabled:!1};return new ve(a,t,Ue,e)};var Gr={};zr(Gr,{blockAPICallsBeforeInitialize:()=>We,blockAcquireTokenInPopups:()=>Er,blockNonBrowserEnvironment:()=>Rr,blockRedirectInIframe:()=>Sr,blockReloadInHiddenIframes:()=>Ar,clearHash:()=>Tt,createGuid:()=>$r,getCurrentUri:()=>L,getHomepage:()=>At,invoke:()=>q,invokeAsync:()=>g,isInIframe:()=>ke,isInPopup:()=>wr,preconnect:()=>be,preflightCheck:()=>ne,redirectPreflightCheck:()=>Ye,replaceHash:()=>wt});function Tt(a){a.location.hash="",typeof a.history.replaceState=="function"&&a.history.replaceState(null,"",`${a.location.origin}${a.location.pathname}${a.location.search}`)}function wt(a){let e=a.split("#");e.shift(),window.location.hash=e.length>0?e.join("#"):""}function ke(){return window.parent!==window}function wr(){return typeof window<"u"&&!!window.opener&&window.opener!==window&&typeof window.name=="string"&&window.name.indexOf(`${N.POPUP_NAME_PREFIX}.`)===0}function L(){return window.location.href.split("?")[0].split("#")[0]}function At(){let e=new b(window.location.href).getUrlComponents();return`${e.Protocol}//${e.HostNameAndPort}/`}function Ar(){if(b.hashContainsKnownProperties(window.location.hash)&&ke())throw u(Jt)}function Sr(a){if(ke()&&!a)throw u(Qt)}function Er(){if(wr())throw u(jt)}function Rr(){if(typeof window>"u")throw u(tr)}function We(a){if(!a)throw u(dr)}function ne(a){Rr(),Ar(),Er(),We(a)}function Ye(a,e){if(ne(a),Sr(e.system.allowRedirectInIframe),e.cache.cacheLocation===R.MemoryStorage&&!e.cache.storeAuthStateInCookie)throw Ge(Ce)}function be(a){let e=document.createElement("link");e.rel="preconnect",e.href=new URL(a).origin,e.crossOrigin="anonymous",document.head.appendChild(e),window.setTimeout(()=>{try{document.head.removeChild(e)}catch{}},1e4)}function $r(){return U()}var Bi="@azure/msal-browser",Qe="3.14.0";var Ie=class{constructor(e,t,r,i,o,n,c,s,l){this.config=e,this.browserStorage=t,this.browserCrypto=r,this.networkClient=this.config.system.networkClient,this.eventHandler=o,this.navigationClient=n,this.nativeMessageHandler=s,this.correlationId=l||U(),this.logger=i.clone(N.MSAL_SKU,Qe,this.correlationId),this.performanceClient=c}clearCacheOnLogout(e){return d(this,null,function*(){if(e){H.accountInfoIsEqual(e,this.browserStorage.getActiveAccount(),!1)&&(this.logger.verbose("Setting active account to null"),this.browserStorage.setActiveAccount(null));try{yield this.browserStorage.removeAccount(H.generateAccountCacheKey(e)),this.logger.verbose("Cleared cache items belonging to the account provided in the logout request.")}catch{this.logger.error("Account provided in logout request was not found. Local cache unchanged.")}}else try{this.logger.verbose("No account provided in logout request, clearing all cache items.",this.correlationId),yield this.browserStorage.clear(),yield this.browserCrypto.clearKeystore()}catch{this.logger.error("Attempted to clear all MSAL cache items and failed. Local cache unchanged.")}})}getRedirectUri(e){this.logger.verbose("getRedirectUri called");let t=e||this.config.auth.redirectUri||L();return b.getAbsoluteUrl(t,L())}initializeServerTelemetryManager(e,t){this.logger.verbose("initializeServerTelemetryManager called");let r={clientId:this.config.auth.clientId,correlationId:this.correlationId,apiId:e,forceRefresh:t||!1,wrapperSKU:this.browserStorage.getWrapperMetadata()[0],wrapperVer:this.browserStorage.getWrapperMetadata()[1]};return new xt(r,this.browserStorage)}getDiscoveredAuthority(e,t,r){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.StandardInteractionClientGetDiscoveredAuthority,this.correlationId);let i={protocolMode:this.config.auth.protocolMode,OIDCOptions:this.config.auth.OIDCOptions,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache},o=e||this.config.auth.authority,n=Ae.generateAuthority(o,t||this.config.auth.azureCloudOptions),c=yield g(Ht.createDiscoveredInstance,h.AuthorityFactoryCreateDiscoveredInstance,this.logger,this.performanceClient,this.correlationId)(n,this.config.system.networkClient,this.browserStorage,i,this.logger,this.correlationId,this.performanceClient);if(r&&!c.isAlias(r.environment))throw te(ee.authorityMismatch);return c})}};var Vr=32;function kr(a,e,t){return d(this,null,function*(){a.addQueueMeasurement(h.GeneratePkceCodes,t);let r=q(Wr,h.GenerateCodeVerifier,e,a,t)(a,e,t),i=yield g(Yr,h.GenerateCodeChallengeFromVerifier,e,a,t)(r,a,e,t);return{verifier:r,challenge:i}})}function Wr(a,e,t){try{let r=new Uint8Array(Vr);return q(Cr,h.GetRandomValues,e,a,t)(r),vt(r)}catch{throw u(mt)}}function Yr(a,e,t,r){return d(this,null,function*(){e.addQueueMeasurement(h.GenerateCodeChallengeFromVerifier,r);try{let i=yield g(fr,h.Sha256Digest,t,e,r)(a,e,r);return vt(new Uint8Array(i))}catch{throw u(mt)}})}function Ne(a,e,t,r){return d(this,null,function*(){t.addQueueMeasurement(h.InitializeBaseRequest,a.correlationId);let i=a.authority||e.auth.authority,o=[...a&&a.scopes||[]],n=y(f({},a),{correlationId:a.correlationId,authority:i,scopes:o});if(!n.authenticationScheme)n.authenticationScheme=x.BEARER,r.verbose(`Authentication Scheme wasn't explicitly set in request, defaulting to "Bearer" request`);else{if(n.authenticationScheme===x.SSH){if(!a.sshJwk)throw te(ee.missingSshJwk);if(!a.sshKid)throw te(ee.missingSshKid)}r.verbose(`Authentication Scheme set to "${n.authenticationScheme}" as configured in Auth request`)}return e.cache.claimsBasedCachingEnabled&&a.claims&&!we.isEmptyObj(a.claims)&&(n.requestedClaimsHash=yield vr(a.claims)),n})}function br(a,e,t,r,i){return d(this,null,function*(){r.addQueueMeasurement(h.InitializeSilentRequest,a.correlationId);let o=yield g(Ne,h.InitializeBaseRequest,i,r,a.correlationId)(a,t,r,i);return y(f(f({},a),o),{account:e,forceRefresh:a.forceRefresh||!1})})}var K=class extends Ie{initializeAuthorizationCodeRequest(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.StandardInteractionClientInitializeAuthorizationCodeRequest,this.correlationId);let t=yield g(kr,h.GeneratePkceCodes,this.logger,this.performanceClient,this.correlationId)(this.performanceClient,this.logger,this.correlationId),r=y(f({},e),{redirectUri:e.redirectUri,code:m.EMPTY_STRING,codeVerifier:t.verifier});return e.codeChallenge=t.challenge,e.codeChallengeMethod=m.S256_CODE_CHALLENGE_METHOD,r})}initializeLogoutRequest(e){this.logger.verbose("initializeLogoutRequest called",e?.correlationId);let t=f({correlationId:this.correlationId||U()},e);if(e)if(e.logoutHint)this.logger.verbose("logoutHint has already been set in logoutRequest");else if(e.account){let r=this.getLogoutHintFromIdTokenClaims(e.account);r&&(this.logger.verbose("Setting logoutHint to login_hint ID Token Claim value for the account provided"),t.logoutHint=r)}else this.logger.verbose("logoutHint was not set and account was not passed into logout request, logoutHint will not be set");else this.logger.verbose("logoutHint will not be set since no logout request was configured");return!e||e.postLogoutRedirectUri!==null?e&&e.postLogoutRedirectUri?(this.logger.verbose("Setting postLogoutRedirectUri to uri set on logout request",t.correlationId),t.postLogoutRedirectUri=b.getAbsoluteUrl(e.postLogoutRedirectUri,L())):this.config.auth.postLogoutRedirectUri===null?this.logger.verbose("postLogoutRedirectUri configured as null and no uri set on request, not passing post logout redirect",t.correlationId):this.config.auth.postLogoutRedirectUri?(this.logger.verbose("Setting postLogoutRedirectUri to configured uri",t.correlationId),t.postLogoutRedirectUri=b.getAbsoluteUrl(this.config.auth.postLogoutRedirectUri,L())):(this.logger.verbose("Setting postLogoutRedirectUri to current page",t.correlationId),t.postLogoutRedirectUri=b.getAbsoluteUrl(L(),L())):this.logger.verbose("postLogoutRedirectUri passed as null, not setting post logout redirect uri",t.correlationId),t}getLogoutHintFromIdTokenClaims(e){let t=e.idTokenClaims;if(t){if(t.login_hint)return t.login_hint;this.logger.verbose("The ID Token Claims tied to the provided account do not contain a login_hint claim, logoutHint will not be added to logout request")}else this.logger.verbose("The provided account does not contain ID Token Claims, logoutHint will not be added to logout request");return null}createAuthCodeClient(e,t,r,i){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.StandardInteractionClientCreateAuthCodeClient,this.correlationId);let o=yield g(this.getClientConfiguration.bind(this),h.StandardInteractionClientGetClientConfiguration,this.logger,this.performanceClient,this.correlationId)(e,t,r,i);return new De(o,this.performanceClient)})}getClientConfiguration(e,t,r,i){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.StandardInteractionClientGetClientConfiguration,this.correlationId);let o=yield g(this.getDiscoveredAuthority.bind(this),h.StandardInteractionClientGetDiscoveredAuthority,this.logger,this.performanceClient,this.correlationId)(t,r,i),n=this.config.system.loggerOptions;return{authOptions:{clientId:this.config.auth.clientId,authority:o,clientCapabilities:this.config.auth.clientCapabilities},systemOptions:{tokenRenewalOffsetSeconds:this.config.system.tokenRenewalOffsetSeconds,preventCorsPreflight:!0},loggerOptions:{loggerCallback:n.loggerCallback,piiLoggingEnabled:n.piiLoggingEnabled,logLevel:n.logLevel,correlationId:this.correlationId},cacheOptions:{claimsBasedCachingEnabled:this.config.cache.claimsBasedCachingEnabled},cryptoInterface:this.browserCrypto,networkInterface:this.networkClient,storageInterface:this.browserStorage,serverTelemetryManager:e,libraryInfo:{sku:N.MSAL_SKU,version:Qe,cpu:m.EMPTY_STRING,os:m.EMPTY_STRING},telemetry:this.config.telemetry}})}initializeAuthorizationRequest(e,t){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.StandardInteractionClientInitializeAuthorizationRequest,this.correlationId);let r=this.getRedirectUri(e.redirectUri),i={interactionType:t},o=B.setRequestState(this.browserCrypto,e&&e.state||m.EMPTY_STRING,i),n=yield g(Ne,h.InitializeBaseRequest,this.logger,this.performanceClient,this.correlationId)(y(f({},e),{correlationId:this.correlationId}),this.config,this.performanceClient,this.logger),c=y(f({},n),{redirectUri:r,state:o,nonce:e.nonce||U(),responseMode:this.config.auth.OIDCOptions.serverResponseType}),s=e.account||this.browserStorage.getActiveAccount();if(s&&(this.logger.verbose("Setting validated request account",this.correlationId),this.logger.verbosePii(`Setting validated request account: ${s.homeAccountId}`,this.correlationId),c.account=s),!c.loginHint&&!s){let l=this.browserStorage.getLegacyLoginHint();l&&(c.loginHint=l)}return c})}};var Nr="ContentError",Je="user_switch";var Pr="USER_INTERACTION_REQUIRED",Mr="USER_CANCEL",_r="NO_NETWORK",Or="PERSISTENT_ERROR",Hr="DISABLED",Br="ACCOUNT_UNAVAILABLE";var Qr=-2147186943,Jr={[Je]:"User attempted to switch accounts in the native broker, which is not allowed. All new accounts must sign-in through the standard web flow first, please try again."},W=class a extends M{constructor(e,t,r){super(e,t),Object.setPrototypeOf(this,a.prototype),this.name="NativeAuthError",this.ext=r}};function ae(a){if(a.ext&&a.ext.status&&(a.ext.status===Or||a.ext.status===Hr)||a.ext&&a.ext.error&&a.ext.error===Qr)return!0;switch(a.errorCode){case Nr:return!0;default:return!1}}function Pe(a,e,t){if(t&&t.status)switch(t.status){case Br:return Bt(ue.nativeAccountUnavailable);case Pr:return new ge(a,e);case Mr:return u(Q);case _r:return u(Se)}return new W(a,Jr[a]||e,t)}var ye=class extends K{acquireToken(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.SilentCacheClientAcquireToken,e.correlationId);let t=this.initializeServerTelemetryManager(w.acquireTokenSilent_silentFlow),r=yield g(this.getClientConfiguration.bind(this),h.StandardInteractionClientGetClientConfiguration,this.logger,this.performanceClient,this.correlationId)(t,e.authority,e.azureCloudOptions,e.account),i=new Lt(r,this.performanceClient);this.logger.verbose("Silent auth client created");try{let n=(yield g(i.acquireCachedToken.bind(i),h.SilentFlowClientAcquireCachedToken,this.logger,this.performanceClient,e.correlationId)(e))[0];return this.performanceClient.addFields({fromCache:!0},e.correlationId),n}catch(o){throw o instanceof gr&&o.errorCode===or&&this.logger.verbose("Signing keypair for bound access token not found. Refreshing bound access token and generating a new crypto keypair."),o}})}logout(e){this.logger.verbose("logoutRedirect called");let t=this.initializeLogoutRequest(e);return this.clearCacheOnLogout(t?.account)}};var St={BROKER_CLIENT_ID:"brk_client_id",BROKER_REDIRECT_URI:"brk_redirect_uri"},$=class extends Ie{constructor(e,t,r,i,o,n,c,s,l,C,I,A){super(e,t,r,i,o,n,s,l,A),this.apiId=c,this.accountId=C,this.nativeMessageHandler=l,this.nativeStorageManager=I,this.silentCacheClient=new ye(e,this.nativeStorageManager,r,i,o,n,s,l,A)}acquireToken(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.NativeInteractionClientAcquireToken,e.correlationId),this.logger.trace("NativeInteractionClient - acquireToken called.");let t=this.performanceClient.startMeasurement(h.NativeInteractionClientAcquireToken,e.correlationId),r=lt.nowSeconds(),i=yield this.initializeNativeRequest(e);try{let s=yield this.acquireTokensFromCache(this.accountId,i);return t.end({success:!0,isNativeBroker:!1,fromCache:!0}),s}catch{this.logger.info("MSAL internal Cache does not contain tokens, proceed to make a native call")}let o={method:J.GetToken,request:i},n=yield this.nativeMessageHandler.sendMessage(o),c=this.validateNativeResponse(n);return this.handleNativeResponse(c,i,r).then(s=>(t.end({success:!0,isNativeBroker:!0,requestId:s.requestId}),s)).catch(s=>{throw t.end({success:!1,errorCode:s.errorCode,subErrorCode:s.subError,isNativeBroker:!0}),s})})}createSilentCacheRequest(e,t){return{authority:e.authority,correlationId:this.correlationId,scopes:Y.fromString(e.scope).asArray(),account:t,forceRefresh:!1}}acquireTokensFromCache(e,t){return d(this,null,function*(){if(!e)throw this.logger.warning("NativeInteractionClient:acquireTokensFromCache - No nativeAccountId provided"),O(_.noAccountFound);let r=this.browserStorage.getBaseAccountInfo({nativeAccountId:e});if(!r)throw O(_.noAccountFound);try{let i=this.createSilentCacheRequest(t,r),o=yield this.silentCacheClient.acquireToken(i),n=y(f({},r),{idTokenClaims:o?.idTokenClaims,idToken:o?.idToken});return y(f({},o),{account:n})}catch(i){throw i}})}acquireTokenRedirect(e){return d(this,null,function*(){this.logger.trace("NativeInteractionClient - acquireTokenRedirect called.");let t=yield this.initializeNativeRequest(e),r={method:J.GetToken,request:t};try{let n=yield this.nativeMessageHandler.sendMessage(r);this.validateNativeResponse(n)}catch(n){if(n instanceof W&&ae(n))throw n}this.browserStorage.setTemporaryCache(T.NATIVE_REQUEST,JSON.stringify(t),!0);let i={apiId:w.acquireTokenRedirect,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},o=this.config.auth.navigateToLoginRequestUrl?window.location.href:this.getRedirectUri(e.redirectUri);yield this.navigationClient.navigateExternal(o,i)})}handleRedirectPromise(e,t){return d(this,null,function*(){if(this.logger.trace("NativeInteractionClient - handleRedirectPromise called."),!this.browserStorage.isInteractionInProgress(!0))return this.logger.info("handleRedirectPromise called but there is no interaction in progress, returning null."),null;let r=this.browserStorage.getCachedNativeRequest();if(!r)return this.logger.verbose("NativeInteractionClient - handleRedirectPromise called but there is no cached request, returning null."),e&&t&&e?.addFields({errorCode:"no_cached_request"},t),null;let s=r,{prompt:i}=s,o=ht(s,["prompt"]);i&&this.logger.verbose("NativeInteractionClient - handleRedirectPromise called and prompt was included in the original request, removing prompt from cached request to prevent second interaction with native broker window."),this.browserStorage.removeItem(this.browserStorage.generateCacheKey(T.NATIVE_REQUEST));let n={method:J.GetToken,request:o},c=lt.nowSeconds();try{this.logger.verbose("NativeInteractionClient - handleRedirectPromise sending message to native broker.");let l=yield this.nativeMessageHandler.sendMessage(n);this.validateNativeResponse(l);let C=this.handleNativeResponse(l,o,c);return this.browserStorage.setInteractionInProgress(!1),yield C}catch(l){throw this.browserStorage.setInteractionInProgress(!1),l}})}logout(){return this.logger.trace("NativeInteractionClient - logout called."),Promise.reject("Logout not implemented yet")}handleNativeResponse(e,t,r){return d(this,null,function*(){this.logger.trace("NativeInteractionClient - handleNativeResponse called.");let i=he.extractTokenClaims(e.id_token,z),o=this.createHomeAccountIdentifier(e,i),n=this.browserStorage.getAccountInfoFilteredBy({nativeAccountId:t.accountId})?.homeAccountId;if(o!==n&&e.account.id!==t.accountId)throw Pe(Je);let c=yield this.getDiscoveredAuthority(t.authority),s=xe(this.browserStorage,c,o,i,z,e.client_info,void 0,i.tid,void 0,e.account.id,this.logger),l=yield this.generateAuthenticationResult(e,t,i,s,c.canonicalAuthority,r);return this.cacheAccount(s),this.cacheNativeTokens(e,t,o,i,l.accessToken,l.tenantId,r),l})}createHomeAccountIdentifier(e,t){return H.generateHomeAccountId(e.client_info||m.EMPTY_STRING,Pt.Default,this.logger,this.browserCrypto,t)}generateScopes(e,t){return e.scope?Y.fromString(e.scope):Y.fromString(t.scope)}generatePopAccessToken(e,t){return d(this,null,function*(){if(t.tokenType===x.POP){if(e.shr)return this.logger.trace("handleNativeServerResponse: SHR is enabled in native layer"),e.shr;let r=new gt(this.browserCrypto),i={resourceRequestMethod:t.resourceRequestMethod,resourceRequestUri:t.resourceRequestUri,shrClaims:t.shrClaims,shrNonce:t.shrNonce};if(!t.keyId)throw O(_.keyIdMissing);return r.signPopToken(e.access_token,t.keyId,i)}else return e.access_token})}generateAuthenticationResult(e,t,r,i,o,n){return d(this,null,function*(){let c=this.addTelemetryFromNativeResponse(e),s=e.scope?Y.fromString(e.scope):Y.fromString(t.scope),l=e.account.properties||{},C=l.UID||r.oid||r.sub||m.EMPTY_STRING,I=l.TenantId||r.tid||m.EMPTY_STRING,A=Nt(i.getAccountInfo(),void 0,r,e.id_token);A.nativeAccountId!==e.account.id&&(A.nativeAccountId=e.account.id);let F=yield this.generatePopAccessToken(e,t),Te=t.tokenType===x.POP?x.POP:x.BEARER;return{authority:o,uniqueId:C,tenantId:I,scopes:s.asArray(),account:A,idToken:e.id_token,idTokenClaims:r,accessToken:F,fromCache:c?this.isResponseFromCache(c):!1,expiresOn:new Date(Number(n+e.expires_in)*1e3),tokenType:Te,correlationId:this.correlationId,state:e.state,fromNativeBroker:!0}})}cacheAccount(e){this.browserStorage.setAccount(e),this.browserStorage.removeAccountContext(e).catch(t=>{this.logger.error(`Error occurred while removing account context from browser storage. ${t}`)})}cacheNativeTokens(e,t,r,i,o,n,c){let s=E.createIdTokenEntity(r,t.authority,e.id_token||"",t.clientId,i.tid||""),l=t.tokenType===x.POP?m.SHR_NONCE_VALIDITY:(typeof e.expires_in=="string"?parseInt(e.expires_in,10):e.expires_in)||0,C=c+l,I=this.generateScopes(e,t),A=E.createAccessTokenEntity(r,t.authority,o,t.clientId,i.tid||n,I.printScopes(),C,0,z),F=new ie(void 0,s,A);this.nativeStorageManager.saveCacheRecord(F,t.storeInCache)}addTelemetryFromNativeResponse(e){let t=this.getMATSFromResponse(e);return t?(this.performanceClient.addFields({extensionId:this.nativeMessageHandler.getExtensionId(),extensionVersion:this.nativeMessageHandler.getExtensionVersion(),matsBrokerVersion:t.broker_version,matsAccountJoinOnStart:t.account_join_on_start,matsAccountJoinOnEnd:t.account_join_on_end,matsDeviceJoin:t.device_join,matsPromptBehavior:t.prompt_behavior,matsApiErrorCode:t.api_error_code,matsUiVisible:t.ui_visible,matsSilentCode:t.silent_code,matsSilentBiSubCode:t.silent_bi_sub_code,matsSilentMessage:t.silent_message,matsSilentStatus:t.silent_status,matsHttpStatus:t.http_status,matsHttpEventCount:t.http_event_count},this.correlationId),t):null}validateNativeResponse(e){if(e.hasOwnProperty("access_token")&&e.hasOwnProperty("id_token")&&e.hasOwnProperty("client_info")&&e.hasOwnProperty("account")&&e.hasOwnProperty("scope")&&e.hasOwnProperty("expires_in"))return e;throw Be(He.unexpectedError,"Response missing expected properties.")}getMATSFromResponse(e){if(e.properties.MATS)try{return JSON.parse(e.properties.MATS)}catch{this.logger.error("NativeInteractionClient - Error parsing MATS telemetry, returning null instead")}return null}isResponseFromCache(e){return typeof e.is_cached>"u"?(this.logger.verbose("NativeInteractionClient - MATS telemetry does not contain field indicating if response was served from cache. Returning false."),!1):!!e.is_cached}initializeNativeRequest(e){return d(this,null,function*(){this.logger.trace("NativeInteractionClient - initializeNativeRequest called");let t=e.authority||this.config.auth.authority;e.account&&(yield this.getDiscoveredAuthority(t,e.azureCloudOptions,e.account));let r=new b(t);r.validateAsUri();let l=e,{scopes:i}=l,o=ht(l,["scopes"]),n=new Y(i||[]);n.appendScopes(Oe);let c=()=>{switch(this.apiId){case w.ssoSilent:case w.acquireTokenSilent_silentFlow:return this.logger.trace("initializeNativeRequest: silent request sets prompt to none"),P.NONE}if(!e.prompt){this.logger.trace("initializeNativeRequest: prompt was not provided");return}switch(e.prompt){case P.NONE:case P.CONSENT:case P.LOGIN:return this.logger.trace("initializeNativeRequest: prompt is compatible with native flow"),e.prompt;default:throw this.logger.trace(`initializeNativeRequest: prompt = ${e.prompt} is not compatible with native flow`),u(ur)}},s=y(f({},o),{accountId:this.accountId,clientId:this.config.auth.clientId,authority:r.urlString,scope:n.printScopes(),redirectUri:this.getRedirectUri(e.redirectUri),prompt:c(),correlationId:this.correlationId,tokenType:e.authenticationScheme,windowTitleSubstring:document.title,extraParameters:f(f({},e.extraQueryParameters),e.tokenQueryParameters),extendedExpiryToken:!1});if(this.handleExtraBrokerParams(s),s.extraParameters=s.extraParameters||{},s.extraParameters.telemetry=ce.MATS_TELEMETRY,e.authenticationScheme===x.POP){let C={resourceRequestUri:e.resourceRequestUri,resourceRequestMethod:e.resourceRequestMethod,shrClaims:e.shrClaims,shrNonce:e.shrNonce},I=new gt(this.browserCrypto),A=yield g(I.generateCnf.bind(I),h.PopTokenGenerateCnf,this.logger,this.performanceClient,this.correlationId)(C,this.logger);s.reqCnf=A.reqCnfHash,s.keyId=A.kid}return s})}handleExtraBrokerParams(e){if(e.extraParameters&&e.extraParameters.hasOwnProperty(St.BROKER_CLIENT_ID)&&e.extraParameters.hasOwnProperty(St.BROKER_REDIRECT_URI)&&e.extraParameters.hasOwnProperty(ut.CLIENT_ID)){let t=e.extraParameters[ut.CLIENT_ID],r=e.redirectUri,i=e.extraParameters[St.BROKER_REDIRECT_URI];e.extraParameters={child_client_id:t,child_redirect_uri:r},e.redirectUri=i}}};var D=class a{constructor(e,t,r,i){this.logger=e,this.handshakeTimeoutMs=t,this.extensionId=i,this.resolvers=new Map,this.handshakeResolvers=new Map,this.messageChannel=new MessageChannel,this.windowListener=this.onWindowMessage.bind(this),this.performanceClient=r,this.handshakeEvent=r.startMeasurement(h.NativeMessageHandlerHandshake)}sendMessage(e){return d(this,null,function*(){this.logger.trace("NativeMessageHandler - sendMessage called.");let t={channel:ce.CHANNEL_ID,extensionId:this.extensionId,responseId:U(),body:e};return this.logger.trace("NativeMessageHandler - Sending request to browser extension"),this.logger.tracePii(`NativeMessageHandler - Sending request to browser extension: ${JSON.stringify(t)}`),this.messageChannel.port1.postMessage(t),new Promise((r,i)=>{this.resolvers.set(t.responseId,{resolve:r,reject:i})})})}static createProvider(e,t,r){return d(this,null,function*(){e.trace("NativeMessageHandler - createProvider called.");try{let i=new a(e,t,r,ce.PREFERRED_EXTENSION_ID);return yield i.sendHandshakeRequest(),i}catch{let o=new a(e,t,r);return yield o.sendHandshakeRequest(),o}})}sendHandshakeRequest(){return d(this,null,function*(){this.logger.trace("NativeMessageHandler - sendHandshakeRequest called."),window.addEventListener("message",this.windowListener,!1);let e={channel:ce.CHANNEL_ID,extensionId:this.extensionId,responseId:U(),body:{method:J.HandshakeRequest}};return this.handshakeEvent.add({extensionId:this.extensionId,extensionHandshakeTimeoutMs:this.handshakeTimeoutMs}),this.messageChannel.port1.onmessage=t=>{this.onChannelMessage(t)},window.postMessage(e,window.origin,[this.messageChannel.port2]),new Promise((t,r)=>{this.handshakeResolvers.set(e.responseId,{resolve:t,reject:r}),this.timeoutId=window.setTimeout(()=>{window.removeEventListener("message",this.windowListener,!1),this.messageChannel.port1.close(),this.messageChannel.port2.close(),this.handshakeEvent.end({extensionHandshakeTimedOut:!0,success:!1}),r(u(hr)),this.handshakeResolvers.delete(e.responseId)},this.handshakeTimeoutMs)})})}onWindowMessage(e){if(this.logger.trace("NativeMessageHandler - onWindowMessage called"),e.source!==window)return;let t=e.data;if(!(!t.channel||t.channel!==ce.CHANNEL_ID)&&!(t.extensionId&&t.extensionId!==this.extensionId)&&t.body.method===J.HandshakeRequest){let r=this.handshakeResolvers.get(t.responseId);if(!r){this.logger.trace(`NativeMessageHandler.onWindowMessage - resolver can't be found for request ${t.responseId}`);return}this.logger.verbose(t.extensionId?`Extension with id: ${t.extensionId} not installed`:"No extension installed"),clearTimeout(this.timeoutId),this.messageChannel.port1.close(),this.messageChannel.port2.close(),window.removeEventListener("message",this.windowListener,!1),this.handshakeEvent.end({success:!1,extensionInstalled:!1}),r.reject(u(lr))}}onChannelMessage(e){this.logger.trace("NativeMessageHandler - onChannelMessage called.");let t=e.data,r=this.resolvers.get(t.responseId),i=this.handshakeResolvers.get(t.responseId);try{let o=t.body.method;if(o===J.Response){if(!r)return;let n=t.body.response;if(this.logger.trace("NativeMessageHandler - Received response from browser extension"),this.logger.tracePii(`NativeMessageHandler - Received response from browser extension: ${JSON.stringify(n)}`),n.status!=="Success")r.reject(Pe(n.code,n.description,n.ext));else if(n.result)n.result.code&&n.result.description?r.reject(Pe(n.result.code,n.result.description,n.result.ext)):r.resolve(n.result);else throw Be(He.unexpectedError,"Event does not contain result.");this.resolvers.delete(t.responseId)}else if(o===J.HandshakeResponse){if(!i){this.logger.trace(`NativeMessageHandler.onChannelMessage - resolver can't be found for request ${t.responseId}`);return}clearTimeout(this.timeoutId),window.removeEventListener("message",this.windowListener,!1),this.extensionId=t.extensionId,this.extensionVersion=t.body.version,this.logger.verbose(`NativeMessageHandler - Received HandshakeResponse from extension: ${this.extensionId}`),this.handshakeEvent.end({extensionInstalled:!0,success:!0}),i.resolve(),this.handshakeResolvers.delete(t.responseId)}}catch(o){this.logger.error("Error parsing response from WAM Extension"),this.logger.errorPii(`Error parsing response from WAM Extension: ${o}`),this.logger.errorPii(`Unable to parse ${e}`),r?r.reject(o):i&&i.reject(o)}}getExtensionId(){return this.extensionId}getExtensionVersion(){return this.extensionVersion}static isNativeAvailable(e,t,r,i){if(t.trace("isNativeAvailable called"),!e.system.allowNativeBroker)return t.trace("isNativeAvailable: allowNativeBroker is not enabled, returning false"),!1;if(!r)return t.trace("isNativeAvailable: WAM extension provider is not initialized, returning false"),!1;if(i)switch(i){case x.BEARER:case x.POP:return t.trace("isNativeAvailable: authenticationScheme is supported, returning true"),!0;default:return t.trace("isNativeAvailable: authenticationScheme is not supported, returning false"),!1}return!0}};var se=class{constructor(e,t,r,i,o){this.authModule=e,this.browserStorage=t,this.authCodeRequest=r,this.logger=i,this.performanceClient=o}handleCodeResponse(e,t){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.HandleCodeResponse,t.correlationId);let r;try{r=this.authModule.handleFragmentResponse(e,t.state)}catch(i){throw i instanceof Le&&i.subError===Q?u(Q):i}return g(this.handleCodeResponseFromServer.bind(this),h.HandleCodeResponseFromServer,this.logger,this.performanceClient,t.correlationId)(r,t)})}handleCodeResponseFromServer(e,t,r=!0){return d(this,null,function*(){if(this.performanceClient.addQueueMeasurement(h.HandleCodeResponseFromServer,t.correlationId),this.logger.trace("InteractionHandler.handleCodeResponseFromServer called"),this.authCodeRequest.code=e.code,e.cloud_instance_host_name&&(yield g(this.authModule.updateAuthority.bind(this.authModule),h.UpdateTokenEndpointAuthority,this.logger,this.performanceClient,t.correlationId)(e.cloud_instance_host_name,t.correlationId)),r&&(e.nonce=t.nonce||void 0),e.state=t.state,e.client_info)this.authCodeRequest.clientInfo=e.client_info;else{let o=this.createCcsCredentials(t);o&&(this.authCodeRequest.ccsCredential=o)}return yield g(this.authModule.acquireToken.bind(this.authModule),h.AuthClientAcquireToken,this.logger,this.performanceClient,t.correlationId)(this.authCodeRequest,e)})}createCcsCredentials(e){return e.account?{credential:e.account.homeAccountId,type:de.HOME_ACCOUNT_ID}:e.loginHint?{credential:e.loginHint,type:de.UPN}:null}};function je(a,e,t){let r=le.getDeserializedResponse(a);if(!r)throw le.stripLeadingHashOrQuery(a)?(t.error(`A ${e} is present in the iframe but it does not contain known properties. It's likely that the ${e} has been replaced by code running on the redirectUri page.`),t.errorPii(`The ${e} detected is: ${a}`),u(qt)):(t.error(`The request has returned to the redirectUri but a ${e} is not present. It's likely that the ${e} has been removed or the page has been redirected by code running on the redirectUri page.`),u(Ft));return r}function Ur(a,e,t){if(!a.state)throw u(Fe);let r=Ve(e,a.state);if(!r)throw u(zt);if(r.interactionType!==t)throw u($t)}var Xe=class extends K{constructor(e,t,r,i,o,n,c,s,l,C){super(e,t,r,i,o,n,c,l,C),this.unloadWindow=this.unloadWindow.bind(this),this.nativeStorage=s}acquireToken(e){try{let t=this.generatePopupName(e.scopes||Oe,e.authority||this.config.auth.authority),r=e.popupWindowAttributes||{};if(this.config.system.asyncPopups)return this.logger.verbose("asyncPopups set to true, acquiring token"),this.acquireTokenPopupAsync(e,t,r);{this.logger.verbose("asyncPopup set to false, opening popup before acquiring token");let i=this.openSizedPopup("about:blank",t,r);return this.acquireTokenPopupAsync(e,t,r,i)}}catch(t){return Promise.reject(t)}}logout(e){try{this.logger.verbose("logoutPopup called");let t=this.initializeLogoutRequest(e),r=this.generateLogoutPopupName(t),i=e&&e.authority,o=e&&e.mainWindowRedirectUri,n=e?.popupWindowAttributes||{};if(this.config.system.asyncPopups)return this.logger.verbose("asyncPopups set to true"),this.logoutPopupAsync(t,r,n,i,void 0,o);{this.logger.verbose("asyncPopup set to false, opening popup");let c=this.openSizedPopup("about:blank",r,n);return this.logoutPopupAsync(t,r,n,i,c,o)}}catch(t){return Promise.reject(t)}}acquireTokenPopupAsync(e,t,r,i){return d(this,null,function*(){this.logger.verbose("acquireTokenPopupAsync called");let o=this.initializeServerTelemetryManager(w.acquireTokenPopup),n=yield g(this.initializeAuthorizationRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationRequest,this.logger,this.performanceClient,this.correlationId)(e,p.Popup);be(n.authority);try{let c=yield g(this.initializeAuthorizationCodeRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationCodeRequest,this.logger,this.performanceClient,this.correlationId)(n),s=yield g(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,this.correlationId)(o,n.authority,n.azureCloudOptions,n.account),l=D.isNativeAvailable(this.config,this.logger,this.nativeMessageHandler,e.authenticationScheme),C;l&&(C=this.performanceClient.startMeasurement(h.FetchAccountIdWithNativeBroker,e.correlationId));let I=yield s.getAuthCodeUrl(y(f({},n),{nativeBroker:l})),A=new se(s,this.browserStorage,c,this.logger,this.performanceClient),F={popup:i,popupName:t,popupWindowAttributes:r},Te=this.initiateAuthRequest(I,F);this.eventHandler.emitEvent(v.POPUP_OPENED,p.Popup,{popupWindow:Te},null);let Et=yield this.monitorPopupForHash(Te),ct=q(je,h.DeserializeResponse,this.logger,this.performanceClient,this.correlationId)(Et,this.config.auth.OIDCOptions.serverResponseType,this.logger);if(Ke.removeThrottle(this.browserStorage,this.config.auth.clientId,c),ct.accountId){if(this.logger.verbose("Account id found in hash, calling WAM for token"),C&&C.end({success:!0,isNativeBroker:!0}),!this.nativeMessageHandler)throw u(oe);let Fr=new $(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,w.acquireTokenPopup,this.performanceClient,this.nativeMessageHandler,ct.accountId,this.nativeStorage,n.correlationId),{userRequestState:qr}=B.parseRequestState(this.browserCrypto,n.state);return yield Fr.acquireToken(y(f({},n),{state:qr,prompt:void 0}))}return yield A.handleCodeResponse(ct,n)}catch(c){throw i&&i.close(),c instanceof M&&(c.setCorrelationId(this.correlationId),o.cacheFailedRequest(c)),c}})}logoutPopupAsync(e,t,r,i,o,n){return d(this,null,function*(){this.logger.verbose("logoutPopupAsync called"),this.eventHandler.emitEvent(v.LOGOUT_START,p.Popup,e);let c=this.initializeServerTelemetryManager(w.logoutPopup);try{yield this.clearCacheOnLogout(e.account);let s=yield g(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,this.correlationId)(c,i,void 0,e.account||void 0);try{s.authority.endSessionEndpoint}catch{if(e.account?.homeAccountId&&e.postLogoutRedirectUri&&s.authority.protocolMode===re.OIDC){if(this.browserStorage.removeAccount(e.account?.homeAccountId),this.eventHandler.emitEvent(v.LOGOUT_SUCCESS,p.Popup,e),n){let I={apiId:w.logoutPopup,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},A=b.getAbsoluteUrl(n,L());yield this.navigationClient.navigateInternal(A,I)}o&&o.close();return}}let l=s.getLogoutUri(e);this.eventHandler.emitEvent(v.LOGOUT_SUCCESS,p.Popup,e);let C=this.openPopup(l,{popupName:t,popupWindowAttributes:r,popup:o});if(this.eventHandler.emitEvent(v.POPUP_OPENED,p.Popup,{popupWindow:C},null),yield this.monitorPopupForHash(C).catch(()=>{}),n){let I={apiId:w.logoutPopup,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},A=b.getAbsoluteUrl(n,L());this.logger.verbose("Redirecting main window to url specified in the request"),this.logger.verbosePii(`Redirecting main window to: ${A}`),yield this.navigationClient.navigateInternal(A,I)}else this.logger.verbose("No main window navigation requested")}catch(s){throw o&&o.close(),s instanceof M&&(s.setCorrelationId(this.correlationId),c.cacheFailedRequest(s)),this.browserStorage.setInteractionInProgress(!1),this.eventHandler.emitEvent(v.LOGOUT_FAILURE,p.Popup,null,s),this.eventHandler.emitEvent(v.LOGOUT_END,p.Popup),s}this.eventHandler.emitEvent(v.LOGOUT_END,p.Popup)})}initiateAuthRequest(e,t){if(e)return this.logger.infoPii(`Navigate to: ${e}`),this.openPopup(e,t);throw this.logger.error("Navigate url is empty"),u(me)}monitorPopupForHash(e){return new Promise((t,r)=>{this.logger.verbose("PopupHandler.monitorPopupForHash - polling started");let i=setInterval(()=>{if(e.closed){this.logger.error("PopupHandler.monitorPopupForHash - window closed"),clearInterval(i),r(u(Q));return}let o="";try{o=e.location.href}catch{}if(!o||o==="about:blank")return;clearInterval(i);let n="",c=this.config.auth.OIDCOptions.serverResponseType;e&&(c===Z.QUERY?n=e.location.search:n=e.location.hash),this.logger.verbose("PopupHandler.monitorPopupForHash - popup window is on same origin as caller"),t(n)},this.config.system.pollIntervalMilliseconds)}).finally(()=>{this.cleanPopup(e)})}openPopup(e,t){try{let r;if(t.popup?(r=t.popup,this.logger.verbosePii(`Navigating popup window to: ${e}`),r.location.assign(e)):typeof t.popup>"u"&&(this.logger.verbosePii(`Opening popup window to: ${e}`),r=this.openSizedPopup(e,t.popupName,t.popupWindowAttributes)),!r)throw u(Wt);return r.focus&&r.focus(),this.currentWindow=r,window.addEventListener("beforeunload",this.unloadWindow),r}catch(r){throw this.logger.error("error opening popup "+r.message),this.browserStorage.setInteractionInProgress(!1),u(Vt)}}openSizedPopup(e,t,r){let i=window.screenLeft?window.screenLeft:window.screenX,o=window.screenTop?window.screenTop:window.screenY,n=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,c=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,s=r.popupSize?.width,l=r.popupSize?.height,C=r.popupPosition?.top,I=r.popupPosition?.left;return(!s||s<0||s>n)&&(this.logger.verbose("Default popup window width used. Window width not configured or invalid."),s=N.POPUP_WIDTH),(!l||l<0||l>c)&&(this.logger.verbose("Default popup window height used. Window height not configured or invalid."),l=N.POPUP_HEIGHT),(!C||C<0||C>c)&&(this.logger.verbose("Default popup window top position used. Window top not configured or invalid."),C=Math.max(0,c/2-N.POPUP_HEIGHT/2+o)),(!I||I<0||I>n)&&(this.logger.verbose("Default popup window left position used. Window left not configured or invalid."),I=Math.max(0,n/2-N.POPUP_WIDTH/2+i)),window.open(e,t,`width=${s}, height=${l}, top=${C}, left=${I}, scrollbars=yes`)}unloadWindow(e){this.browserStorage.cleanRequestByInteractionType(p.Popup),this.currentWindow&&this.currentWindow.close(),e.preventDefault()}cleanPopup(e){e&&e.close(),window.removeEventListener("beforeunload",this.unloadWindow),this.browserStorage.setInteractionInProgress(!1)}generatePopupName(e,t){return`${N.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${e.join("-")}.${t}.${this.correlationId}`}generateLogoutPopupName(e){let t=e.account&&e.account.homeAccountId;return`${N.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${t}.${this.correlationId}`}};var Me=class{constructor(e,t,r,i,o){this.authModule=e,this.browserStorage=t,this.authCodeRequest=r,this.logger=i,this.performanceClient=o}initiateAuthRequest(e,t){return d(this,null,function*(){if(this.logger.verbose("RedirectHandler.initiateAuthRequest called"),e){t.redirectStartPage&&(this.logger.verbose("RedirectHandler.initiateAuthRequest: redirectStartPage set, caching start page"),this.browserStorage.setTemporaryCache(T.ORIGIN_URI,t.redirectStartPage,!0)),this.browserStorage.setTemporaryCache(T.CORRELATION_ID,this.authCodeRequest.correlationId,!0),this.browserStorage.cacheCodeRequest(this.authCodeRequest),this.logger.infoPii(`RedirectHandler.initiateAuthRequest: Navigate to: ${e}`);let r={apiId:w.acquireTokenRedirect,timeout:t.redirectTimeout,noHistory:!1};if(typeof t.onRedirectNavigate=="function")if(this.logger.verbose("RedirectHandler.initiateAuthRequest: Invoking onRedirectNavigate callback"),t.onRedirectNavigate(e)!==!1){this.logger.verbose("RedirectHandler.initiateAuthRequest: onRedirectNavigate did not return false, navigating"),yield t.navigationClient.navigateExternal(e,r);return}else{this.logger.verbose("RedirectHandler.initiateAuthRequest: onRedirectNavigate returned false, stopping navigation");return}else{this.logger.verbose("RedirectHandler.initiateAuthRequest: Navigating window to navigate url"),yield t.navigationClient.navigateExternal(e,r);return}}else throw this.logger.info("RedirectHandler.initiateAuthRequest: Navigate url is empty"),u(me)})}handleCodeResponse(e,t){return d(this,null,function*(){this.logger.verbose("RedirectHandler.handleCodeResponse called"),this.browserStorage.setInteractionInProgress(!1);let r=this.browserStorage.generateStateKey(t),i=this.browserStorage.getTemporaryCache(r);if(!i)throw O(_.stateNotFound,"Cached State");let o;try{o=this.authModule.handleFragmentResponse(e,i)}catch(l){throw l instanceof Le&&l.subError===Q?u(Q):l}let n=this.browserStorage.generateNonceKey(i),c=this.browserStorage.getTemporaryCache(n);if(this.authCodeRequest.code=o.code,o.cloud_instance_host_name&&(yield g(this.authModule.updateAuthority.bind(this.authModule),h.UpdateTokenEndpointAuthority,this.logger,this.performanceClient,this.authCodeRequest.correlationId)(o.cloud_instance_host_name,this.authCodeRequest.correlationId)),o.nonce=c||void 0,o.state=i,o.client_info)this.authCodeRequest.clientInfo=o.client_info;else{let l=this.checkCcsCredentials();l&&(this.authCodeRequest.ccsCredential=l)}let s=yield this.authModule.acquireToken(this.authCodeRequest,o);return this.browserStorage.cleanRequestByState(t),s})}checkCcsCredentials(){let e=this.browserStorage.getTemporaryCache(T.CCS_CREDENTIAL,!0);if(e)try{return JSON.parse(e)}catch{this.authModule.logger.error("Cache credential could not be parsed"),this.authModule.logger.errorPii(`Cache credential could not be parsed: ${e}`)}return null}};var Ze=class extends K{constructor(e,t,r,i,o,n,c,s,l,C){super(e,t,r,i,o,n,c,l,C),this.nativeStorage=s}acquireToken(e){return d(this,null,function*(){let t=yield g(this.initializeAuthorizationRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationRequest,this.logger,this.performanceClient,this.correlationId)(e,p.Redirect);this.browserStorage.updateCacheEntries(t.state,t.nonce,t.authority,t.loginHint||"",t.account||null);let r=this.initializeServerTelemetryManager(w.acquireTokenRedirect),i=o=>{o.persisted&&(this.logger.verbose("Page was restored from back/forward cache. Clearing temporary cache."),this.browserStorage.cleanRequestByState(t.state),this.eventHandler.emitEvent(v.RESTORE_FROM_BFCACHE,p.Redirect))};try{let o=yield g(this.initializeAuthorizationCodeRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationCodeRequest,this.logger,this.performanceClient,this.correlationId)(t),n=yield g(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,this.correlationId)(r,t.authority,t.azureCloudOptions,t.account),c=new Me(n,this.browserStorage,o,this.logger,this.performanceClient),s=yield n.getAuthCodeUrl(y(f({},t),{nativeBroker:D.isNativeAvailable(this.config,this.logger,this.nativeMessageHandler,e.authenticationScheme)})),l=this.getRedirectStartPage(e.redirectStartPage);return this.logger.verbosePii(`Redirect start page: ${l}`),window.addEventListener("pageshow",i),yield c.initiateAuthRequest(s,{navigationClient:this.navigationClient,redirectTimeout:this.config.system.redirectNavigationTimeout,redirectStartPage:l,onRedirectNavigate:e.onRedirectNavigate})}catch(o){throw o instanceof M&&(o.setCorrelationId(this.correlationId),r.cacheFailedRequest(o)),window.removeEventListener("pageshow",i),this.browserStorage.cleanRequestByState(t.state),o}})}handleRedirectPromise(e="",t){return d(this,null,function*(){let r=this.initializeServerTelemetryManager(w.handleRedirectPromise);try{if(!this.browserStorage.isInteractionInProgress(!0))return this.logger.info("handleRedirectPromise called but there is no interaction in progress, returning null."),null;let[i,o]=this.getRedirectResponse(e||"");if(!i)return this.logger.info("handleRedirectPromise did not detect a response as a result of a redirect. Cleaning temporary cache."),this.browserStorage.cleanRequestByInteractionType(p.Redirect),t.event.errorCode="no_server_response",null;let n=this.browserStorage.getTemporaryCache(T.ORIGIN_URI,!0)||m.EMPTY_STRING,c=b.removeHashFromUrl(n),s=b.removeHashFromUrl(window.location.href);if(c===s&&this.config.auth.navigateToLoginRequestUrl)return this.logger.verbose("Current page is loginRequestUrl, handling response"),n.indexOf("#")>-1&&wt(n),yield this.handleResponse(i,r);if(this.config.auth.navigateToLoginRequestUrl){if(!ke()||this.config.system.allowRedirectInIframe){this.browserStorage.setTemporaryCache(T.URL_HASH,o,!0);let l={apiId:w.handleRedirectPromise,timeout:this.config.system.redirectNavigationTimeout,noHistory:!0},C=!0;if(!n||n==="null"){let I=At();this.browserStorage.setTemporaryCache(T.ORIGIN_URI,I,!0),this.logger.warning("Unable to get valid login request url from cache, redirecting to home page"),C=yield this.navigationClient.navigateInternal(I,l)}else this.logger.verbose(`Navigating to loginRequestUrl: ${n}`),C=yield this.navigationClient.navigateInternal(n,l);if(!C)return yield this.handleResponse(i,r)}}else return this.logger.verbose("NavigateToLoginRequestUrl set to false, handling response"),yield this.handleResponse(i,r);return null}catch(i){throw i instanceof M&&(i.setCorrelationId(this.correlationId),r.cacheFailedRequest(i)),this.browserStorage.cleanRequestByInteractionType(p.Redirect),i}})}getRedirectResponse(e){this.logger.verbose("getRedirectResponseHash called");let t=e;t||(this.config.auth.OIDCOptions.serverResponseType===Z.QUERY?t=window.location.search:t=window.location.hash);let r=le.getDeserializedResponse(t);if(r){try{Ur(r,this.browserCrypto,p.Redirect)}catch(o){return o instanceof M&&this.logger.error(`Interaction type validation failed due to ${o.errorCode}: ${o.errorMessage}`),[null,""]}return Tt(window),this.logger.verbose("Hash contains known properties, returning response hash"),[r,t]}let i=this.browserStorage.getTemporaryCache(T.URL_HASH,!0);return this.browserStorage.removeItem(this.browserStorage.generateCacheKey(T.URL_HASH)),i&&(r=le.getDeserializedResponse(i),r)?(this.logger.verbose("Hash does not contain known properties, returning cached hash"),[r,i]):[null,""]}handleResponse(e,t){return d(this,null,function*(){let r=e.state;if(!r)throw u(Fe);let i=this.browserStorage.getCachedRequest(r);if(this.logger.verbose("handleResponse called, retrieved cached request"),e.accountId){if(this.logger.verbose("Account id found in hash, calling WAM for token"),!this.nativeMessageHandler)throw u(oe);let s=new $(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,w.acquireTokenPopup,this.performanceClient,this.nativeMessageHandler,e.accountId,this.nativeStorage,i.correlationId),{userRequestState:l}=B.parseRequestState(this.browserCrypto,r);return s.acquireToken(y(f({},i),{state:l,prompt:void 0})).finally(()=>{this.browserStorage.cleanRequestByState(r)})}let o=this.browserStorage.getCachedAuthority(r);if(!o)throw u(qe);let n=yield g(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,this.correlationId)(t,o);return Ke.removeThrottle(this.browserStorage,this.config.auth.clientId,i),new Me(n,this.browserStorage,i,this.logger,this.performanceClient).handleCodeResponse(e,r)})}logout(e){return d(this,null,function*(){this.logger.verbose("logoutRedirect called");let t=this.initializeLogoutRequest(e),r=this.initializeServerTelemetryManager(w.logout);try{this.eventHandler.emitEvent(v.LOGOUT_START,p.Redirect,e),yield this.clearCacheOnLogout(t.account);let i={apiId:w.logout,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},o=yield g(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,this.correlationId)(r,e&&e.authority,void 0,e&&e.account||void 0);if(o.authority.protocolMode===re.OIDC)try{o.authority.endSessionEndpoint}catch{if(t.account?.homeAccountId){this.browserStorage.removeAccount(t.account?.homeAccountId),this.eventHandler.emitEvent(v.LOGOUT_SUCCESS,p.Redirect,t);return}}let n=o.getLogoutUri(t);if(this.eventHandler.emitEvent(v.LOGOUT_SUCCESS,p.Redirect,t),e&&typeof e.onRedirectNavigate=="function")if(e.onRedirectNavigate(n)!==!1){this.logger.verbose("Logout onRedirectNavigate did not return false, navigating"),this.browserStorage.getInteractionInProgress()||this.browserStorage.setInteractionInProgress(!0),yield this.navigationClient.navigateExternal(n,i);return}else this.browserStorage.setInteractionInProgress(!1),this.logger.verbose("Logout onRedirectNavigate returned false, stopping navigation");else{this.browserStorage.getInteractionInProgress()||this.browserStorage.setInteractionInProgress(!0),yield this.navigationClient.navigateExternal(n,i);return}}catch(i){throw i instanceof M&&(i.setCorrelationId(this.correlationId),r.cacheFailedRequest(i)),this.eventHandler.emitEvent(v.LOGOUT_FAILURE,p.Redirect,null,i),this.eventHandler.emitEvent(v.LOGOUT_END,p.Redirect),i}this.eventHandler.emitEvent(v.LOGOUT_END,p.Redirect)})}getRedirectStartPage(e){let t=e||window.location.href;return b.getAbsoluteUrl(t,L())}};var et=class a{navigateInternal(e,t){return a.defaultNavigateWindow(e,t)}navigateExternal(e,t){return a.defaultNavigateWindow(e,t)}static defaultNavigateWindow(e,t){return t.noHistory?window.location.replace(e):window.location.assign(e),new Promise(r=>{setTimeout(()=>{r(!0)},t.timeout)})}};var tt=class{sendGetRequestAsync(e,t){return d(this,null,function*(){let r;try{r=yield fetch(e,{method:ft.GET,headers:this.getFetchHeaders(t)})}catch{throw window.navigator.onLine?u(ir):u(Se)}try{return{headers:this.getHeaderDict(r.headers),body:yield r.json(),status:r.status}}catch{throw u(pt)}})}sendPostRequestAsync(e,t){return d(this,null,function*(){let r=t&&t.body||m.EMPTY_STRING,i;try{i=yield fetch(e,{method:ft.POST,headers:this.getFetchHeaders(t),body:r})}catch{throw window.navigator.onLine?u(rr):u(Se)}try{return{headers:this.getHeaderDict(i.headers),body:yield i.json(),status:i.status}}catch{throw u(pt)}})}getFetchHeaders(e){let t=new Headers;if(!(e&&e.headers))return t;let r=e.headers;return Object.keys(r).forEach(i=>{t.append(i,r[i])}),t}getHeaderDict(e){let t={};return e.forEach((r,i)=>{t[i]=r}),t}};var jr=6e4,rt=1e4,Xr=3e4,Zr=2e3;function Vn({auth:a,cache:e,system:t,telemetry:r},i){let o={clientId:m.EMPTY_STRING,authority:`${m.DEFAULT_AUTHORITY}`,knownAuthorities:[],cloudDiscoveryMetadata:m.EMPTY_STRING,authorityMetadata:m.EMPTY_STRING,redirectUri:m.EMPTY_STRING,postLogoutRedirectUri:m.EMPTY_STRING,navigateToLoginRequestUrl:!0,clientCapabilities:[],protocolMode:re.AAD,OIDCOptions:{serverResponseType:Z.FRAGMENT,defaultScopes:[m.OPENID_SCOPE,m.PROFILE_SCOPE,m.OFFLINE_ACCESS_SCOPE]},azureCloudOptions:{azureCloudInstance:bt.None,tenant:m.EMPTY_STRING},skipAuthorityMetadataCache:!1,supportsNestedAppAuth:!1},n={cacheLocation:R.SessionStorage,temporaryCacheLocation:R.SessionStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!!(e&&e.cacheLocation===R.LocalStorage),claimsBasedCachingEnabled:!1},c={loggerCallback:()=>{},logLevel:Rt.Info,piiLoggingEnabled:!1},s=y(f({},_t),{loggerOptions:c,networkClient:i?new tt:Kt,navigationClient:new et,loadFrameTimeout:0,windowHashTimeout:t?.loadFrameTimeout||jr,iframeHashTimeout:t?.loadFrameTimeout||rt,navigateFrameWait:0,redirectNavigationTimeout:Xr,asyncPopups:!1,allowRedirectInIframe:!1,allowNativeBroker:!1,nativeBrokerHandshakeTimeout:t?.nativeBrokerHandshakeTimeout||Zr,pollIntervalMilliseconds:N.DEFAULT_POLL_INTERVAL_MS}),l=y(f(f({},s),t),{loggerOptions:t?.loggerOptions||c}),C={application:{appName:m.EMPTY_STRING,appVersion:m.EMPTY_STRING},client:new Dt};if(a?.protocolMode!==re.OIDC&&a?.OIDCOptions&&new kt(l.loggerOptions).warning(JSON.stringify(te(ee.cannotSetOIDCOptions))),a?.protocolMode&&a.protocolMode!==re.AAD&&l?.allowNativeBroker)throw te(ee.cannotAllowNativeBroker);return{auth:y(f(f({},o),a),{OIDCOptions:f(f({},o.OIDCOptions),a?.OIDCOptions)}),cache:f(f({},n),e),system:l,telemetry:f(f({},C),r)}}function Lr(a,e,t,r,i){return d(this,null,function*(){if(e.addQueueMeasurement(h.SilentHandlerInitiateAuthRequest,r),!a)throw t.info("Navigate url is empty"),u(me);return i?g(ei,h.SilentHandlerLoadFrame,t,e,r)(a,i,e,r):q(ti,h.SilentHandlerLoadFrameSync,t,e,r)(a)})}function Kr(a,e,t,r,i,o,n){return d(this,null,function*(){return r.addQueueMeasurement(h.SilentHandlerMonitorIframeForHash,o),new Promise((c,s)=>{e<rt&&i.warning(`system.loadFrameTimeout or system.iframeHashTimeout set to lower (${e}ms) than the default (${rt}ms). This may result in timeouts.`);let l=window.setTimeout(()=>{window.clearInterval(C),s(u(Yt))},e),C=window.setInterval(()=>{let I="",A=a.contentWindow;try{I=A?A.location.href:""}catch{}if(!I||I==="about:blank")return;let F="";A&&(n===Z.QUERY?F=A.location.search:F=A.location.hash),window.clearTimeout(l),window.clearInterval(C),c(F)},t)}).finally(()=>{q(ri,h.RemoveHiddenIframe,i,r,o)(a)})})}function ei(a,e,t,r){return t.addQueueMeasurement(h.SilentHandlerLoadFrame,r),new Promise((i,o)=>{let n=xr();window.setTimeout(()=>{if(!n){o("Unable to load iframe");return}n.src=a,i(n)},e)})}function ti(a){let e=xr();return e.src=a,e}function xr(){let a=document.createElement("iframe");return a.className="msalSilentIframe",a.style.visibility="hidden",a.style.position="absolute",a.style.width=a.style.height="0",a.style.border="0",a.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms"),document.body.appendChild(a),a}function ri(a){document.body===a.parentNode&&document.body.removeChild(a)}var it=class extends K{constructor(e,t,r,i,o,n,c,s,l,C,I){super(e,t,r,i,o,n,s,C,I),this.apiId=c,this.nativeStorage=l}acquireToken(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.SilentIframeClientAcquireToken,e.correlationId),!e.loginHint&&!e.sid&&(!e.account||!e.account.username)&&this.logger.warning("No user hint provided. The authorization server may need more information to complete this request.");let t=f({},e);t.prompt?t.prompt!==P.NONE&&t.prompt!==P.NO_SESSION&&(this.logger.warning(`SilentIframeClient. Replacing invalid prompt ${t.prompt} with ${P.NONE}`),t.prompt=P.NONE):t.prompt=P.NONE;let r=yield g(this.initializeAuthorizationRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationRequest,this.logger,this.performanceClient,e.correlationId)(t,p.Silent);be(r.authority);let i=this.initializeServerTelemetryManager(this.apiId);try{let o=yield g(this.createAuthCodeClient.bind(this),h.StandardInteractionClientCreateAuthCodeClient,this.logger,this.performanceClient,e.correlationId)(i,r.authority,r.azureCloudOptions,r.account);return yield g(this.silentTokenHelper.bind(this),h.SilentIframeClientTokenHelper,this.logger,this.performanceClient,e.correlationId)(o,r)}catch(o){throw o instanceof M&&(o.setCorrelationId(this.correlationId),i.cacheFailedRequest(o)),o}})}logout(){return Promise.reject(u(pe))}silentTokenHelper(e,t){return d(this,null,function*(){let r=t.correlationId;this.performanceClient.addQueueMeasurement(h.SilentIframeClientTokenHelper,r);let i=yield g(this.initializeAuthorizationCodeRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationCodeRequest,this.logger,this.performanceClient,r)(t),o=yield g(e.getAuthCodeUrl.bind(e),h.GetAuthCodeUrl,this.logger,this.performanceClient,r)(y(f({},t),{nativeBroker:D.isNativeAvailable(this.config,this.logger,this.nativeMessageHandler,t.authenticationScheme)})),n=new se(e,this.browserStorage,i,this.logger,this.performanceClient),c=yield g(Lr,h.SilentHandlerInitiateAuthRequest,this.logger,this.performanceClient,r)(o,this.performanceClient,this.logger,r,this.config.system.navigateFrameWait),s=this.config.auth.OIDCOptions.serverResponseType,l=yield g(Kr,h.SilentHandlerMonitorIframeForHash,this.logger,this.performanceClient,r)(c,this.config.system.iframeHashTimeout,this.config.system.pollIntervalMilliseconds,this.performanceClient,this.logger,r,s),C=q(je,h.DeserializeResponse,this.logger,this.performanceClient,this.correlationId)(l,s,this.logger);if(C.accountId){if(this.logger.verbose("Account id found in hash, calling WAM for token"),!this.nativeMessageHandler)throw u(oe);let I=new $(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.apiId,this.performanceClient,this.nativeMessageHandler,C.accountId,this.browserStorage,r),{userRequestState:A}=B.parseRequestState(this.browserCrypto,t.state);return g(I.acquireToken.bind(I),h.NativeInteractionClientAcquireToken,this.logger,this.performanceClient,r)(y(f({},t),{state:A,prompt:t.prompt||P.NONE}))}return g(n.handleCodeResponse.bind(n),h.HandleCodeResponse,this.logger,this.performanceClient,r)(C,t)})}};var ot=class extends K{acquireToken(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.SilentRefreshClientAcquireToken,e.correlationId);let t=yield g(Ne,h.InitializeBaseRequest,this.logger,this.performanceClient,e.correlationId)(e,this.config,this.performanceClient,this.logger),r=f(f({},e),t);e.redirectUri&&(r.redirectUri=this.getRedirectUri(e.redirectUri));let i=this.initializeServerTelemetryManager(w.acquireTokenSilent_silentFlow),o=yield this.createRefreshTokenClient(i,r.authority,r.azureCloudOptions,r.account);return g(o.acquireTokenByRefreshToken.bind(o),h.RefreshTokenClientAcquireTokenByRefreshToken,this.logger,this.performanceClient,e.correlationId)(r).catch(n=>{throw n.setCorrelationId(this.correlationId),i.cacheFailedRequest(n),n})})}logout(){return Promise.reject(u(pe))}createRefreshTokenClient(e,t,r,i){return d(this,null,function*(){let o=yield g(this.getClientConfiguration.bind(this),h.StandardInteractionClientGetClientConfiguration,this.logger,this.performanceClient,this.correlationId)(e,t,r,i);return new Ut(o,this.performanceClient)})}};var nt=class{constructor(e,t,r,i){this.isBrowserEnvironment=typeof window<"u",this.config=e,this.storage=t,this.logger=r,this.cryptoObj=i}loadExternalTokens(e,t,r){if(this.logger.info("TokenCache - loadExternalTokens called"),!t.id_token)throw u(G);let i=he.extractTokenClaims(t.id_token,z),o,n,c;if(e.account)c=H.createFromAccountInfo(e.account),o=new ie(c,this.loadIdToken(t.id_token,c.homeAccountId,e.account.environment,e.account.tenantId),this.loadAccessToken(e,t,c.homeAccountId,e.account.environment,e.account.tenantId,r),this.loadRefreshToken(e,t,c.homeAccountId,e.account.environment));else if(e.authority){let s=Ae.generateAuthority(e.authority,e.azureCloudOptions),l={protocolMode:this.config.auth.protocolMode,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache};if(n=new Ae(s,this.config.system.networkClient,this.storage,l,this.logger,e.correlationId||U()),r.clientInfo)this.logger.trace("TokenCache - homeAccountId from options"),c=this.loadAccount(i,n,r.clientInfo),o=new ie(c,this.loadIdToken(t.id_token,c.homeAccountId,n.hostnameAndPort,n.tenant),this.loadAccessToken(e,t,c.homeAccountId,n.hostnameAndPort,n.tenant,r),this.loadRefreshToken(e,t,c.homeAccountId,n.hostnameAndPort));else if(t.client_info)this.logger.trace("TokenCache - homeAccountId from response"),c=this.loadAccount(i,n,t.client_info),o=new ie(c,this.loadIdToken(t.id_token,c.homeAccountId,n.hostnameAndPort,n.tenant),this.loadAccessToken(e,t,c.homeAccountId,n.hostnameAndPort,n.tenant,r),this.loadRefreshToken(e,t,c.homeAccountId,n.hostnameAndPort));else throw u(G)}else throw u(G);return this.generateAuthenticationResult(e,i,o,c,n)}loadAccount(e,t,r,i){if(this.isBrowserEnvironment){this.logger.verbose("TokenCache - loading account");let o;if(i?o=i:t.authorityType!==void 0&&r&&(o=H.generateHomeAccountId(r,t.authorityType,this.logger,this.cryptoObj,e)),!o)throw u(G);let n=e.tid,c=xe(this.storage,t,o,e,z,r,t.hostnameAndPort,n,void 0,void 0,this.logger);return this.storage.setAccount(c),c}else throw u(G)}loadIdToken(e,t,r,i){let o=E.createIdTokenEntity(t,r,e,this.config.auth.clientId,i);if(this.isBrowserEnvironment)return this.logger.verbose("TokenCache - loading id token"),this.storage.setIdTokenCredential(o),o;throw u(G)}loadAccessToken(e,t,r,i,o,n){if(!t.access_token)return this.logger.verbose("TokenCache - No access token provided for caching"),null;if(!t.expires_in)throw u(G);if(!n.extendedExpiresOn)throw u(G);let c=new Y(e.scopes).printScopes(),s=n.expiresOn||t.expires_in+new Date().getTime()/1e3,l=n.extendedExpiresOn,C=E.createAccessTokenEntity(r,i,t.access_token,this.config.auth.clientId,o,c,s,l,z);if(this.isBrowserEnvironment)return this.logger.verbose("TokenCache - loading access token"),this.storage.setAccessTokenCredential(C),C;throw u(G)}loadRefreshToken(e,t,r,i){if(!t.refresh_token)return this.logger.verbose("TokenCache - No refresh token provided for caching"),null;let o=E.createRefreshTokenEntity(r,i,t.refresh_token,this.config.auth.clientId);if(this.isBrowserEnvironment)return this.logger.verbose("TokenCache - loading refresh token"),this.storage.setRefreshTokenCredential(o),o;throw u(G)}generateAuthenticationResult(e,t,r,i,o){let n=m.EMPTY_STRING,c=[],s=null,l;r?.accessToken&&(n=r.accessToken.secret,c=Y.fromString(r.accessToken.target).asArray(),s=new Date(Number(r.accessToken.expiresOn)*1e3),l=new Date(Number(r.accessToken.extendedExpiresOn)*1e3));let C=t.oid||t.sub||m.EMPTY_STRING,I=t.tid||m.EMPTY_STRING;return{authority:o?o.canonicalAuthority:m.EMPTY_STRING,uniqueId:C,tenantId:I,scopes:c,account:i.getAccountInfo(),idToken:r.idToken?.secret||"",idTokenClaims:t||{},accessToken:n,fromCache:!0,expiresOn:s,correlationId:e.correlationId||m.EMPTY_STRING,requestId:m.EMPTY_STRING,extExpiresOn:l,familyId:m.EMPTY_STRING,tokenType:r?.accessToken?.tokenType||m.EMPTY_STRING,state:m.EMPTY_STRING,cloudGraphHostName:i.cloudGraphHostName||m.EMPTY_STRING,msGraphHost:i.msGraphHost||m.EMPTY_STRING,code:void 0,fromNativeBroker:!1}}};var at=class extends De{constructor(e){super(e),this.includeRedirectUri=!1}};var st=class extends K{constructor(e,t,r,i,o,n,c,s,l,C){super(e,t,r,i,o,n,s,l,C),this.apiId=c}acquireToken(e){return d(this,null,function*(){if(!e.code)throw u(nr);let t=yield g(this.initializeAuthorizationRequest.bind(this),h.StandardInteractionClientInitializeAuthorizationRequest,this.logger,this.performanceClient,e.correlationId)(e,p.Silent),r=this.initializeServerTelemetryManager(this.apiId);try{let i=y(f({},t),{code:e.code}),o=yield g(this.getClientConfiguration.bind(this),h.StandardInteractionClientGetClientConfiguration,this.logger,this.performanceClient,e.correlationId)(r,t.authority,t.azureCloudOptions,t.account),n=new at(o);this.logger.verbose("Auth code client created");let c=new se(n,this.browserStorage,i,this.logger,this.performanceClient);return yield g(c.handleCodeResponseFromServer.bind(c),h.HandleCodeResponseFromServer,this.logger,this.performanceClient,e.correlationId)({code:e.code,msgraph_host:e.msGraphHost,cloud_graph_host_name:e.cloudGraphHostName,cloud_instance_host_name:e.cloudInstanceHostName},t,!1)}catch(i){throw i instanceof M&&(i.setCorrelationId(this.correlationId),r.cacheFailedRequest(i)),i}})}logout(){return Promise.reject(u(pe))}};function X(a){let e=a?.idTokenClaims;if(e?.tfp||e?.acr)return"B2C";if(e?.tid){if(e?.tid==="9188040d-6c67-4c5b-b112-36a304b66dad")return"MSA"}else return;return"AAD"}var Dr=class a{constructor(e){this.operatingContext=e,this.isBrowserEnvironment=this.operatingContext.isBrowserEnvironment(),this.config=e.getConfig(),this.initialized=!1,this.logger=this.operatingContext.getLogger(),this.networkClient=this.config.system.networkClient,this.navigationClient=this.config.system.navigationClient,this.redirectResponse=new Map,this.hybridAuthCodeResponses=new Map,this.performanceClient=this.config.telemetry.client,this.browserCrypto=this.isBrowserEnvironment?new Ir(this.logger,this.performanceClient):Ue,this.eventHandler=new yr(this.logger,this.browserCrypto),this.browserStorage=this.isBrowserEnvironment?new ve(this.config.auth.clientId,this.config.cache,this.browserCrypto,this.logger,Ot(this.config.auth),this.performanceClient):Tr(this.config.auth.clientId,this.logger);let t={cacheLocation:R.MemoryStorage,temporaryCacheLocation:R.MemoryStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!1,claimsBasedCachingEnabled:!1};this.nativeInternalStorage=new ve(this.config.auth.clientId,t,this.browserCrypto,this.logger,void 0,this.performanceClient),this.tokenCache=new nt(this.config,this.browserStorage,this.logger,this.browserCrypto),this.activeSilentTokenRequests=new Map,this.trackPageVisibility=this.trackPageVisibility.bind(this),this.trackPageVisibilityWithMeasurement=this.trackPageVisibilityWithMeasurement.bind(this)}static createController(e){return d(this,null,function*(){let t=new a(e);return yield t.initialize(),t})}trackPageVisibility(e){e&&(this.logger.info("Perf: Visibility change detected"),this.performanceClient.incrementFields({visibilityChangeCount:1},e))}initialize(){return d(this,null,function*(){if(this.logger.trace("initialize called"),this.initialized){this.logger.info("initialize has already been called, exiting early.");return}let e=this.config.system.allowNativeBroker,t=this.performanceClient.startMeasurement(h.InitializeClientApplication);if(this.eventHandler.emitEvent(v.INITIALIZE_START),e)try{this.nativeExtensionProvider=yield D.createProvider(this.logger,this.config.system.nativeBrokerHandshakeTimeout,this.performanceClient)}catch(r){this.logger.verbose(r)}this.config.cache.claimsBasedCachingEnabled||(this.logger.verbose("Claims-based caching is disabled. Clearing the previous cache with claims"),yield g(this.browserStorage.clearTokensAndKeysWithClaims.bind(this.browserStorage),h.ClearTokensAndKeysWithClaims,this.logger,this.performanceClient)(this.performanceClient)),this.initialized=!0,this.eventHandler.emitEvent(v.INITIALIZE_END),t.end({allowNativeBroker:e,success:!0})})}handleRedirectPromise(e){return d(this,null,function*(){if(this.logger.verbose("handleRedirectPromise called"),We(this.initialized),this.isBrowserEnvironment){let t=e||"",r=this.redirectResponse.get(t);return typeof r>"u"?(r=this.handleRedirectPromiseInternal(e),this.redirectResponse.set(t,r),this.logger.verbose("handleRedirectPromise has been called for the first time, storing the promise")):this.logger.verbose("handleRedirectPromise has been called previously, returning the result from the first call"),r}return this.logger.verbose("handleRedirectPromise returns null, not browser environment"),null})}handleRedirectPromiseInternal(e){return d(this,null,function*(){let t=this.getAllAccounts(),r=this.browserStorage.getCachedNativeRequest(),i=r&&D.isNativeAvailable(this.config,this.logger,this.nativeExtensionProvider)&&this.nativeExtensionProvider&&!e,o=i?r?.correlationId:this.browserStorage.getTemporaryCache(T.CORRELATION_ID,!0)||"",n=this.performanceClient.startMeasurement("acquireTokenRedirect",o);this.eventHandler.emitEvent(v.HANDLE_REDIRECT_START,p.Redirect);let c;if(i&&this.nativeExtensionProvider){this.logger.trace("handleRedirectPromise - acquiring token from native platform");let s=new $(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,w.handleRedirectPromise,this.performanceClient,this.nativeExtensionProvider,r.accountId,this.nativeInternalStorage,r.correlationId);c=g(s.handleRedirectPromise.bind(s),h.HandleNativeRedirectPromiseMeasurement,this.logger,this.performanceClient,n.event.correlationId)(this.performanceClient,n.event.correlationId)}else{this.logger.trace("handleRedirectPromise - acquiring token from web flow");let s=this.createRedirectClient(o);c=g(s.handleRedirectPromise.bind(s),h.HandleRedirectPromiseMeasurement,this.logger,this.performanceClient,n.event.correlationId)(e,n)}return c.then(s=>(s?(t.length<this.getAllAccounts().length?(this.eventHandler.emitEvent(v.LOGIN_SUCCESS,p.Redirect,s),this.logger.verbose("handleRedirectResponse returned result, login success")):(this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_SUCCESS,p.Redirect,s),this.logger.verbose("handleRedirectResponse returned result, acquire token success")),n.end({success:!0,accountType:X(s.account)})):n.event.errorCode?n.end({success:!1}):n.discard(),this.eventHandler.emitEvent(v.HANDLE_REDIRECT_END,p.Redirect),s)).catch(s=>{let l=s;throw t.length>0?this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_FAILURE,p.Redirect,null,l):this.eventHandler.emitEvent(v.LOGIN_FAILURE,p.Redirect,null,l),this.eventHandler.emitEvent(v.HANDLE_REDIRECT_END,p.Redirect),n.end({success:!1},l),s})})}acquireTokenRedirect(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);this.logger.verbose("acquireTokenRedirect called",t),Ye(this.initialized,this.config),this.browserStorage.setInteractionInProgress(!0);let r=this.getAllAccounts().length>0;r?this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_START,p.Redirect,e):this.eventHandler.emitEvent(v.LOGIN_START,p.Redirect,e);let i;return this.nativeExtensionProvider&&this.canUseNative(e)?i=new $(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,w.acquireTokenRedirect,this.performanceClient,this.nativeExtensionProvider,this.getNativeAccountId(e),this.nativeInternalStorage,t).acquireTokenRedirect(e).catch(n=>{if(n instanceof W&&ae(n))return this.nativeExtensionProvider=void 0,this.createRedirectClient(t).acquireToken(e);if(n instanceof ge)return this.logger.verbose("acquireTokenRedirect - Resolving interaction required error thrown by native broker by falling back to web flow"),this.createRedirectClient(t).acquireToken(e);throw this.browserStorage.setInteractionInProgress(!1),n}):i=this.createRedirectClient(t).acquireToken(e),i.catch(o=>{throw r?this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_FAILURE,p.Redirect,null,o):this.eventHandler.emitEvent(v.LOGIN_FAILURE,p.Redirect,null,o),o})})}acquireTokenPopup(e){let t=this.getRequestCorrelationId(e),r=this.performanceClient.startMeasurement(h.AcquireTokenPopup,t);r.add({scenarioId:e.scenarioId,accountType:X(e.account)});try{this.logger.verbose("acquireTokenPopup called",t),ne(this.initialized),this.browserStorage.setInteractionInProgress(!0)}catch(n){return Promise.reject(n)}let i=this.getAllAccounts();i.length>0?this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_START,p.Popup,e):this.eventHandler.emitEvent(v.LOGIN_START,p.Popup,e);let o;return this.canUseNative(e)?o=this.acquireTokenNative(y(f({},e),{correlationId:t}),w.acquireTokenPopup).then(n=>(this.browserStorage.setInteractionInProgress(!1),r.end({success:!0,isNativeBroker:!0,requestId:n.requestId,accountType:X(n.account)}),n)).catch(n=>{if(n instanceof W&&ae(n))return this.nativeExtensionProvider=void 0,this.createPopupClient(t).acquireToken(e);if(n instanceof ge)return this.logger.verbose("acquireTokenPopup - Resolving interaction required error thrown by native broker by falling back to web flow"),this.createPopupClient(t).acquireToken(e);throw this.browserStorage.setInteractionInProgress(!1),n}):o=this.createPopupClient(t).acquireToken(e),o.then(n=>(i.length<this.getAllAccounts().length?this.eventHandler.emitEvent(v.LOGIN_SUCCESS,p.Popup,n):this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_SUCCESS,p.Popup,n),r.end({success:!0,requestId:n.requestId,accessTokenSize:n.accessToken.length,idTokenSize:n.idToken.length,accountType:X(n.account)}),n)).catch(n=>(i.length>0?this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_FAILURE,p.Popup,null,n):this.eventHandler.emitEvent(v.LOGIN_FAILURE,p.Popup,null,n),r.end({success:!1},n),Promise.reject(n)))}trackPageVisibilityWithMeasurement(){let e=this.ssoSilentMeasurement||this.acquireTokenByCodeAsyncMeasurement;e&&(this.logger.info("Perf: Visibility change detected in ",e.event.name),e.increment({visibilityChangeCount:1}))}ssoSilent(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e),r=y(f({},e),{prompt:e.prompt,correlationId:t});ne(this.initialized),this.ssoSilentMeasurement=this.performanceClient.startMeasurement(h.SsoSilent,t),this.ssoSilentMeasurement?.increment({visibilityChangeCount:0}),this.ssoSilentMeasurement?.add({scenarioId:e.scenarioId,accountType:X(e.account)}),document.addEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement),this.logger.verbose("ssoSilent called",t),this.eventHandler.emitEvent(v.SSO_SILENT_START,p.Silent,r);let i;return this.canUseNative(r)?i=this.acquireTokenNative(r,w.ssoSilent).catch(o=>{if(o instanceof W&&ae(o))return this.nativeExtensionProvider=void 0,this.createSilentIframeClient(r.correlationId).acquireToken(r);throw o}):i=this.createSilentIframeClient(r.correlationId).acquireToken(r),i.then(o=>(this.eventHandler.emitEvent(v.SSO_SILENT_SUCCESS,p.Silent,o),this.ssoSilentMeasurement?.end({success:!0,isNativeBroker:o.fromNativeBroker,requestId:o.requestId,accessTokenSize:o.accessToken.length,idTokenSize:o.idToken.length,accountType:X(o.account)}),o)).catch(o=>{throw this.eventHandler.emitEvent(v.SSO_SILENT_FAILURE,p.Silent,null,o),this.ssoSilentMeasurement?.end({success:!1},o),o}).finally(()=>{document.removeEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement)})})}acquireTokenByCode(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);this.logger.trace("acquireTokenByCode called",t),ne(this.initialized),this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_BY_CODE_START,p.Silent,e);let r=this.performanceClient.startMeasurement(h.AcquireTokenByCode,t);r.add({scenarioId:e.scenarioId});try{if(e.code&&e.nativeAccountId)throw u(sr);if(e.code){let i=e.code,o=this.hybridAuthCodeResponses.get(i);return o?(this.logger.verbose("Existing acquireTokenByCode request found",t),r.discard()):(this.logger.verbose("Initiating new acquireTokenByCode request",t),o=this.acquireTokenByCodeAsync(y(f({},e),{correlationId:t})).then(n=>(this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_BY_CODE_SUCCESS,p.Silent,n),this.hybridAuthCodeResponses.delete(i),r.end({success:!0,isNativeBroker:n.fromNativeBroker,requestId:n.requestId,accessTokenSize:n.accessToken.length,idTokenSize:n.idToken.length,accountType:X(n.account)}),n)).catch(n=>{throw this.hybridAuthCodeResponses.delete(i),this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_BY_CODE_FAILURE,p.Silent,null,n),r.end({success:!1},n),n}),this.hybridAuthCodeResponses.set(i,o)),yield o}else if(e.nativeAccountId)if(this.canUseNative(e,e.nativeAccountId)){let i=yield this.acquireTokenNative(y(f({},e),{correlationId:t}),w.acquireTokenByCode,e.nativeAccountId).catch(o=>{throw o instanceof W&&ae(o)&&(this.nativeExtensionProvider=void 0),o});return r.end({accountType:X(i.account),success:!0}),i}else throw u(cr);else throw u(ar)}catch(i){throw this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_BY_CODE_FAILURE,p.Silent,null,i),r.end({success:!1},i),i}})}acquireTokenByCodeAsync(e){return d(this,null,function*(){return this.logger.trace("acquireTokenByCodeAsync called",e.correlationId),this.acquireTokenByCodeAsyncMeasurement=this.performanceClient.startMeasurement(h.AcquireTokenByCodeAsync,e.correlationId),this.acquireTokenByCodeAsyncMeasurement?.increment({visibilityChangeCount:0}),document.addEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement),yield this.createSilentAuthCodeClient(e.correlationId).acquireToken(e).then(i=>(this.acquireTokenByCodeAsyncMeasurement?.end({success:!0,fromCache:i.fromCache,isNativeBroker:i.fromNativeBroker,requestId:i.requestId}),i)).catch(i=>{throw this.acquireTokenByCodeAsyncMeasurement?.end({success:!1},i),i}).finally(()=>{document.removeEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement)})})}acquireTokenFromCache(e,t){return d(this,null,function*(){switch(this.performanceClient.addQueueMeasurement(h.AcquireTokenFromCache,e.correlationId),t){case V.Default:case V.AccessToken:case V.AccessTokenAndRefreshToken:let r=this.createSilentCacheClient(e.correlationId);return g(r.acquireToken.bind(r),h.SilentCacheClientAcquireToken,this.logger,this.performanceClient,e.correlationId)(e);default:throw O(_.tokenRefreshRequired)}})}acquireTokenByRefreshToken(e,t){return d(this,null,function*(){switch(this.performanceClient.addQueueMeasurement(h.AcquireTokenByRefreshToken,e.correlationId),t){case V.Default:case V.AccessTokenAndRefreshToken:case V.RefreshToken:case V.RefreshTokenAndNetwork:let r=this.createSilentRefreshClient(e.correlationId);return g(r.acquireToken.bind(r),h.SilentRefreshClientAcquireToken,this.logger,this.performanceClient,e.correlationId)(e);default:throw O(_.tokenRefreshRequired)}})}acquireTokenBySilentIframe(e){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.AcquireTokenBySilentIframe,e.correlationId);let t=this.createSilentIframeClient(e.correlationId);return g(t.acquireToken.bind(t),h.SilentIframeClientAcquireToken,this.logger,this.performanceClient,e.correlationId)(e)})}logout(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);return this.logger.warning("logout API is deprecated and will be removed in msal-browser v3.0.0. Use logoutRedirect instead.",t),this.logoutRedirect(f({correlationId:t},e))})}logoutRedirect(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);return Ye(this.initialized,this.config),this.browserStorage.setInteractionInProgress(!0),this.createRedirectClient(t).logout(e)})}logoutPopup(e){try{let t=this.getRequestCorrelationId(e);return ne(this.initialized),this.browserStorage.setInteractionInProgress(!0),this.createPopupClient(t).logout(e)}catch(t){return Promise.reject(t)}}clearCache(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);return this.createSilentCacheClient(t).logout(e)})}getAllAccounts(e){return this.logger.verbose("getAllAccounts called"),this.isBrowserEnvironment?this.browserStorage.getAllAccounts(e):[]}getAccount(e){if(this.logger.trace("getAccount called"),Object.keys(e).length===0)return this.logger.warning("getAccount: No accountFilter provided"),null;let t=this.browserStorage.getAccountInfoFilteredBy(e);return t?(this.logger.verbose("getAccount: Account matching provided filter found, returning"),t):(this.logger.verbose("getAccount: No matching account found, returning null"),null)}getAccountByUsername(e){if(this.logger.trace("getAccountByUsername called"),!e)return this.logger.warning("getAccountByUsername: No username provided"),null;let t=this.browserStorage.getAccountInfoFilteredBy({username:e});return t?(this.logger.verbose("getAccountByUsername: Account matching username found, returning"),this.logger.verbosePii(`getAccountByUsername: Returning signed-in accounts matching username: ${e}`),t):(this.logger.verbose("getAccountByUsername: No matching account found, returning null"),null)}getAccountByHomeId(e){if(this.logger.trace("getAccountByHomeId called"),!e)return this.logger.warning("getAccountByHomeId: No homeAccountId provided"),null;let t=this.browserStorage.getAccountInfoFilteredBy({homeAccountId:e});return t?(this.logger.verbose("getAccountByHomeId: Account matching homeAccountId found, returning"),this.logger.verbosePii(`getAccountByHomeId: Returning signed-in accounts matching homeAccountId: ${e}`),t):(this.logger.verbose("getAccountByHomeId: No matching account found, returning null"),null)}getAccountByLocalId(e){if(this.logger.trace("getAccountByLocalId called"),!e)return this.logger.warning("getAccountByLocalId: No localAccountId provided"),null;let t=this.browserStorage.getAccountInfoFilteredBy({localAccountId:e});return t?(this.logger.verbose("getAccountByLocalId: Account matching localAccountId found, returning"),this.logger.verbosePii(`getAccountByLocalId: Returning signed-in accounts matching localAccountId: ${e}`),t):(this.logger.verbose("getAccountByLocalId: No matching account found, returning null"),null)}setActiveAccount(e){this.browserStorage.setActiveAccount(e)}getActiveAccount(){return this.browserStorage.getActiveAccount()}hydrateCache(e,t){return d(this,null,function*(){this.logger.verbose("hydrateCache called");let r=H.createFromAccountInfo(e.account,e.cloudGraphHostName,e.msGraphHost);return this.browserStorage.setAccount(r),e.fromNativeBroker?(this.logger.verbose("Response was from native broker, storing in-memory"),this.nativeInternalStorage.hydrateCache(e,t)):this.browserStorage.hydrateCache(e,t)})}acquireTokenNative(e,t,r){return d(this,null,function*(){if(this.logger.trace("acquireTokenNative called"),!this.nativeExtensionProvider)throw u(oe);return new $(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,t,this.performanceClient,this.nativeExtensionProvider,r||this.getNativeAccountId(e),this.nativeInternalStorage,e.correlationId).acquireToken(e)})}canUseNative(e,t){if(this.logger.trace("canUseNative called"),!D.isNativeAvailable(this.config,this.logger,this.nativeExtensionProvider,e.authenticationScheme))return this.logger.trace("canUseNative: isNativeAvailable returned false, returning false"),!1;if(e.prompt)switch(e.prompt){case P.NONE:case P.CONSENT:case P.LOGIN:this.logger.trace("canUseNative: prompt is compatible with native flow");break;default:return this.logger.trace(`canUseNative: prompt = ${e.prompt} is not compatible with native flow, returning false`),!1}return!t&&!this.getNativeAccountId(e)?(this.logger.trace("canUseNative: nativeAccountId is not available, returning false"),!1):!0}getNativeAccountId(e){let t=e.account||this.getAccount({loginHint:e.loginHint,sid:e.sid})||this.getActiveAccount();return t&&t.nativeAccountId||""}createPopupClient(e){return new Xe(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeInternalStorage,this.nativeExtensionProvider,e)}createRedirectClient(e){return new Ze(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeInternalStorage,this.nativeExtensionProvider,e)}createSilentIframeClient(e){return new it(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,w.ssoSilent,this.performanceClient,this.nativeInternalStorage,this.nativeExtensionProvider,e)}createSilentCacheClient(e){return new ye(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeExtensionProvider,e)}createSilentRefreshClient(e){return new ot(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeExtensionProvider,e)}createSilentAuthCodeClient(e){return new st(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,w.acquireTokenByCode,this.performanceClient,this.nativeExtensionProvider,e)}addEventCallback(e){return this.eventHandler.addEventCallback(e)}removeEventCallback(e){this.eventHandler.removeEventCallback(e)}addPerformanceCallback(e){return this.performanceClient.addPerformanceCallback(e)}removePerformanceCallback(e){return this.performanceClient.removePerformanceCallback(e)}enableAccountStorageEvents(){this.eventHandler.enableAccountStorageEvents()}disableAccountStorageEvents(){this.eventHandler.disableAccountStorageEvents()}getTokenCache(){return this.tokenCache}getLogger(){return this.logger}setLogger(e){this.logger=e}initializeWrapperLibrary(e,t){this.browserStorage.setWrapperMetadata(e,t)}setNavigationClient(e){this.navigationClient=e}getConfiguration(){return this.config}getPerformanceClient(){return this.performanceClient}isBrowserEnv(){return this.isBrowserEnvironment}getEventHandler(){return this.eventHandler}getRequestCorrelationId(e){return e?.correlationId?e.correlationId:this.isBrowserEnvironment?U():m.EMPTY_STRING}loginRedirect(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e);return this.logger.verbose("loginRedirect called",t),this.acquireTokenRedirect(f({correlationId:t},e||Ct))})}loginPopup(e){let t=this.getRequestCorrelationId(e);return this.logger.verbose("loginPopup called",t),this.acquireTokenPopup(f({correlationId:t},e||Ct))}acquireTokenSilent(e){return d(this,null,function*(){let t=this.getRequestCorrelationId(e),r=this.performanceClient.startMeasurement(h.AcquireTokenSilent,t);r.add({cacheLookupPolicy:e.cacheLookupPolicy,scenarioId:e.scenarioId}),ne(this.initialized),this.logger.verbose("acquireTokenSilent called",t);let i=e.account||this.getActiveAccount();if(!i)throw u(Xt);r.add({accountType:X(i)});let o={clientId:this.config.auth.clientId,authority:e.authority||m.EMPTY_STRING,scopes:e.scopes,homeAccountIdentifier:i.homeAccountId,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid,shrOptions:e.shrOptions},n=JSON.stringify(o),c=this.activeSilentTokenRequests.get(n);if(typeof c>"u"){this.logger.verbose("acquireTokenSilent called for the first time, storing active request",t);let s=g(this.acquireTokenSilentAsync.bind(this),h.AcquireTokenSilentAsync,this.logger,this.performanceClient,t)(y(f({},e),{correlationId:t}),i).then(l=>(this.activeSilentTokenRequests.delete(n),r.end({success:!0,fromCache:l.fromCache,isNativeBroker:l.fromNativeBroker,cacheLookupPolicy:e.cacheLookupPolicy,requestId:l.requestId,accessTokenSize:l.accessToken.length,idTokenSize:l.idToken.length}),l)).catch(l=>{throw this.activeSilentTokenRequests.delete(n),r.end({success:!1},l),l});return this.activeSilentTokenRequests.set(n,s),y(f({},yield s),{state:e.state})}else return this.logger.verbose("acquireTokenSilent has been called previously, returning the result from the first call",t),r.discard(),y(f({},yield c),{state:e.state})})}acquireTokenSilentAsync(e,t){return d(this,null,function*(){this.performanceClient.addQueueMeasurement(h.AcquireTokenSilentAsync,e.correlationId),this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_START,p.Silent,e),e.correlationId&&this.performanceClient.incrementFields({visibilityChangeCount:0},e.correlationId),document.addEventListener("visibilitychange",()=>this.trackPageVisibility(e.correlationId));let r=yield g(br,h.InitializeSilentRequest,this.logger,this.performanceClient,e.correlationId)(e,t,this.config,this.performanceClient,this.logger),i=e.cacheLookupPolicy||V.Default;return this.acquireTokenSilentNoIframe(r,i).catch(n=>d(this,null,function*(){if(ii(n,i))if(this.activeIframeRequest)if(i!==V.Skip){let[s,l]=this.activeIframeRequest;this.logger.verbose(`Iframe request is already in progress, awaiting resolution for request with correlationId: ${l}`,r.correlationId);let C=this.performanceClient.startMeasurement(h.AwaitConcurrentIframe,r.correlationId);C.add({awaitIframeCorrelationId:l});let I=yield s;if(C.end({success:I}),I)return this.logger.verbose(`Parallel iframe request with correlationId: ${l} succeeded. Retrying cache and/or RT redemption`,r.correlationId),this.acquireTokenSilentNoIframe(r,i);throw this.logger.info(`Iframe request with correlationId: ${l} failed. Interaction is required.`),n}else return this.logger.warning("Another iframe request is currently in progress and CacheLookupPolicy is set to Skip. This may result in degraded performance and/or reliability for both calls. Please consider changing the CacheLookupPolicy to take advantage of request queuing and token cache.",r.correlationId),g(this.acquireTokenBySilentIframe.bind(this),h.AcquireTokenBySilentIframe,this.logger,this.performanceClient,r.correlationId)(r);else{let s;return this.activeIframeRequest=[new Promise(l=>{s=l}),r.correlationId],this.logger.verbose("Refresh token expired/invalid or CacheLookupPolicy is set to Skip, attempting acquire token by iframe.",r.correlationId),g(this.acquireTokenBySilentIframe.bind(this),h.AcquireTokenBySilentIframe,this.logger,this.performanceClient,r.correlationId)(r).then(l=>(s(!0),l)).catch(l=>{throw s(!1),l}).finally(()=>{this.activeIframeRequest=void 0})}else throw n})).then(n=>(this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_SUCCESS,p.Silent,n),e.correlationId&&this.performanceClient.addFields({fromCache:n.fromCache,isNativeBroker:n.fromNativeBroker,requestId:n.requestId},e.correlationId),n)).catch(n=>{throw this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_FAILURE,p.Silent,null,n),n}).finally(()=>{document.removeEventListener("visibilitychange",()=>this.trackPageVisibility(e.correlationId))})})}acquireTokenSilentNoIframe(e,t){return d(this,null,function*(){return D.isNativeAvailable(this.config,this.logger,this.nativeExtensionProvider,e.authenticationScheme)&&e.account.nativeAccountId?(this.logger.verbose("acquireTokenSilent - attempting to acquire token from native platform"),this.acquireTokenNative(e,w.acquireTokenSilent_silentFlow).catch(r=>d(this,null,function*(){throw r instanceof W&&ae(r)?(this.logger.verbose("acquireTokenSilent - native platform unavailable, falling back to web flow"),this.nativeExtensionProvider=void 0,O(_.tokenRefreshRequired)):r}))):(this.logger.verbose("acquireTokenSilent - attempting to acquire token from web flow"),g(this.acquireTokenFromCache.bind(this),h.AcquireTokenFromCache,this.logger,this.performanceClient,e.correlationId)(e,t).catch(r=>{if(t===V.AccessToken)throw r;return this.eventHandler.emitEvent(v.ACQUIRE_TOKEN_NETWORK_START,p.Silent,e),g(this.acquireTokenByRefreshToken.bind(this),h.AcquireTokenByRefreshToken,this.logger,this.performanceClient,e.correlationId)(e,t)}))})}};function ii(a,e){let t=!(a instanceof ge&&a.subError!==ue.badToken),r=a.errorCode===N.INVALID_GRANT_ERROR||a.errorCode===_.tokenRefreshRequired,i=t&&r||a.errorCode===ue.noTokensFound||a.errorCode===ue.refreshTokenExpired,o=mr.includes(e);return i&&o}export{yt as a,Gr as b,Vn as c,Bi as d,Qe as e,Dr as f};
